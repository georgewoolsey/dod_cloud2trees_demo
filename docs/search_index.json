[["index.html", "DoD cloud2trees Demonstration: Forest Fuel Quantification for Wildfire Modeling using QUIC-Fire Section 1 Introduction 1.1 Objective 1.2 Data", " DoD cloud2trees Demonstration: Forest Fuel Quantification for Wildfire Modeling using QUIC-Fire George Woolsey, Wade Tinkham, Chad Hoffman, and Sophie Bonner 15 July, 2025 Section 1 Introduction Demonstration of cloud2trees for processing aerial point cloud data to generate inputs for QUIC-Fire 1.1 Objective The objective of this study is to demonstrate the use of cloud2trees for processing aerial point cloud data to generate inputs for QUIC-Fire. We will use the framework to process ALS and UAS-SfM datasets across geographically variable demonstration sites. The cloud2trees framework generates a tree list containing individual tree-level attributes such as geographic coordinates (X, Y), height, DBH, crown dimensions, forest type, and wildfire-relevant fuel loading metrics like crown bulk density and crown base height. The outputs from cloud2trees will be prepared for ingestion into the QUIC-Fire model (perhaps this is built into the package by now???) to showcase the framework’s processing efficiency and reliability for timely wildfire behavior modeling. 1.2 Data ALS data was mostly obtained at the USGS LidarExplorer and UAS-SfM data was….. "],["data-preparation.html", "Section 2 Data Preparation 2.1 Study Sites 2.2 Point Cloud Data 2.3 ITD window functions 2.4 Other plotting functions", " Section 2 Data Preparation Let’s check out the data we need to process and create: 1) a processing data frame; 2) a LAS catalog (lidR package) with information on the point cloud data The priority list for processing this data is: Sycan ALS Fort Stewart ALS New Jersey ALS Salt Cabin SfM Fort Stewart UAS Lidar Sycan UAS Lidar Salt Cabin ALS I debated creating an automated pipeline to process all of the data but instead will create individual sections for each of the study sites and process them manually. This will overcome the challenge of defining unique variable window functions for use in ITD which we’ll tune using cloud2trees::itd_tuning() Load the standard libraries we use to do work # bread-and-butter library(tidyverse) # the tidyverse library(viridis) # viridis colors library(harrypotter) # hp colors library(RColorBrewer) # brewer colors library(scales) # work with number and plot scales library(latex2exp) # visualization library(mapview) # interactive html maps library(kableExtra) # tables library(patchwork) # combine plots library(ggmap) # correlation plots # spatial analysis library(terra) # raster library(sf) # simple features library(lidR) # lidar data library(rgl) # 3d plots library(cloud2trees) # the cloud2trees 2.1 Study Sites let’s check out the vector data of the study sites dir_temp &lt;- &quot;../data&quot; # what vector data? df_temp &lt;- list.files(dir_temp, pattern = &quot;.*\\\\.(shp|gpkg)$&quot;, recursive = T) %&gt;% dplyr::tibble() %&gt;% setNames(&quot;fpath&quot;) %&gt;% dplyr::filter( !str_detect(fpath, &quot;point_cloud_processing&quot;) ) %&gt;% dplyr::mutate( study_site = dirname(fpath) , fpath = file.path(dir_temp, fpath) , fdir = dirname(fpath) ) %&gt;% dplyr::group_by(study_site) %&gt;% dplyr::filter(dplyr::row_number()==1) %&gt;% dplyr::ungroup() if(nrow(df_temp)==0){stop(&quot;no vector data found&quot;)} # load in the vector data study_sites_sf &lt;- 1:nrow(df_temp) %&gt;% purrr::map(\\(x) sf::st_read( dsn = df_temp$fpath[x] ) %&gt;% # put all in the same projection sf::st_transform(crs=5070) %&gt;% dplyr::mutate(study_site = df_temp$study_site[x]) %&gt;% dplyr::select(study_site) ) %&gt;% dplyr::bind_rows() %&gt;% dplyr::inner_join(df_temp, by = &quot;study_site&quot;) ## Reading layer `Burn Unit F6_6&#39; from data source ## `C:\\Data\\usfs\\dod_cloud2trees_demo\\data\\FortStewart\\Burn Unit F6_6.shp&#39; ## using driver `ESRI Shapefile&#39; ## Simple feature collection with 1 feature and 6 fields ## Geometry type: POLYGON ## Dimension: XY ## Bounding box: xmin: 431049.1 ymin: 3543511 xmax: 434589.8 ymax: 3545826 ## Projected CRS: WGS 84 / UTM zone 17N ## Reading layer `CB_BurnBlock&#39; from data source ## `C:\\Data\\usfs\\dod_cloud2trees_demo\\data\\NewJersey\\CB_BurnBlock.shp&#39; ## using driver `ESRI Shapefile&#39; ## Simple feature collection with 1 feature and 13 fields ## Geometry type: POLYGON ## Dimension: XY ## Bounding box: xmin: 525216.5 ymin: 365372.9 xmax: 529448.3 ymax: 370453.3 ## Projected CRS: NAD83 / New Jersey (ftUS) ## Reading layer `SaltCabin_Unit2_Boundary&#39; from data source ## `C:\\Data\\usfs\\dod_cloud2trees_demo\\data\\SaltCabin\\SaltCabin_Unit2_Boundary.shp&#39; ## using driver `ESRI Shapefile&#39; ## Simple feature collection with 1 feature and 4 fields ## Geometry type: POLYGON ## Dimension: XY ## Bounding box: xmin: 453612.2 ymin: 4502029 xmax: 454053.5 ymax: 4502398 ## Projected CRS: NAD83 / UTM zone 13N ## Reading layer `Sycan_2A&#39; from data source ## `C:\\Data\\usfs\\dod_cloud2trees_demo\\data\\SycanMarsh\\Sycan_2A.shp&#39; ## using driver `ESRI Shapefile&#39; ## Simple feature collection with 1 feature and 10 fields ## Geometry type: POLYGON ## Dimension: XY ## Bounding box: xmin: 4748335 ymin: 436780.6 xmax: 4750706 ymax: 438275.2 ## Projected CRS: NAD_1983_StatePlane_Oregon_South_FIPS_3602_Feet # figure out where the point cloud data is ptcld_df_temp &lt;- 1:nrow(study_sites_sf) %&gt;% purrr::map(function(x){ # look for dirs with las/laz dirs &lt;- study_sites_sf$fdir[x] %&gt;% list.files(pattern = &quot;.*\\\\.(laz|las)$&quot;, recursive = T, full.names = T) %&gt;% dirname() %&gt;% tolower() %&gt;% unique() %&gt;% purrr::keep( ~ !str_detect(.x, &quot;point_cloud_processing&quot;) ) # gen df df &lt;- dplyr::tibble( als_dir = character(1) , uas_lidar_dir = character(1) , uas_sfm_dir = character(1) ) %&gt;% dplyr::mutate( als_dir = purrr::keep(dirs, ~ str_detect(.x, &quot;als&quot;))[1] %&gt;% dplyr::coalesce(as.character(NA)) , uas_lidar_dir = purrr::keep(dirs, ~ str_detect(.x, &quot;uas&quot;) &amp; str_detect(.x, &quot;lidar&quot;))[1] %&gt;% dplyr::coalesce(as.character(NA)) , uas_sfm_dir = purrr::keep(dirs, ~ str_detect(.x, &quot;uas&quot;) &amp; str_detect(.x, &quot;sfm&quot;))[1] %&gt;% dplyr::coalesce(as.character(NA)) , fdir = study_sites_sf$fdir[x] ) return(df) }) %&gt;% dplyr::bind_rows() # add ptcld dirs to data study_sites_sf &lt;- study_sites_sf %&gt;% dplyr::left_join(ptcld_df_temp, by = &quot;fdir&quot;) # what? study_sites_sf %&gt;% dplyr::glimpse() ## Rows: 4 ## Columns: 7 ## $ study_site &lt;chr&gt; &quot;FortStewart&quot;, &quot;NewJersey&quot;, &quot;SaltCabin&quot;, &quot;SycanMarsh&quot; ## $ fpath &lt;chr&gt; &quot;../data/FortStewart/Burn Unit F6_6.shp&quot;, &quot;../data/NewJe… ## $ fdir &lt;chr&gt; &quot;../data/FortStewart&quot;, &quot;../data/NewJersey&quot;, &quot;../data/Sal… ## $ als_dir &lt;chr&gt; &quot;../data/fortstewart/als_2018_laz_files&quot;, &quot;../data/newje… ## $ uas_lidar_dir &lt;chr&gt; &quot;../data/fortstewart/not_actually_uas_lidar_but_data_use… ## $ uas_sfm_dir &lt;chr&gt; NA, NA, &quot;../data/saltcabin/uas_sfm_2024&quot;, NA ## $ geometry &lt;POLYGON [m]&gt; POLYGON ((1336943 1097560, ..., POLYGON ((1817860 207637… where are these places? # first plot a point so we can see it on the map mapview::mapview( sf::st_centroid(study_sites_sf) , zcol = &quot;study_site&quot; , cex = 5 , label = T , legend = T , popup = T , layer.name = &quot;study areas&quot; ) + # add the study bounds mapview::mapview( study_sites_sf , color = &quot;black&quot; , lwd = 2 , alpha.regions = 0 , label = F , legend = F , popup = F ) let’s create a pretty name for each site study_sites_sf &lt;- study_sites_sf %&gt;% dplyr::mutate( study_site_lab = dplyr::case_match( tolower(study_site) , &quot;fortstewart&quot; ~ &quot;Fort Stewart (GA)&quot; , &quot;newjersey&quot; ~ &quot;Cedar Bridge (NJ)&quot; , &quot;saltcabin&quot; ~ &quot;Salt Cabin (CO)&quot; , &quot;sycanmarsh&quot; ~ &quot;Sycan Marsh (OR)&quot; ) %&gt;% dplyr::coalesce(study_site) ) 2.2 Point Cloud Data Let’s check out the point cloud data we got las_df_temp &lt;- study_sites_sf %&gt;% sf::st_drop_geometry() %&gt;% dplyr::select(study_site, tidyselect::ends_with(&quot;_dir&quot;)) %&gt;% tidyr::pivot_longer( cols = -c(study_site) , values_drop_na = T ) %&gt;% dplyr::mutate( name = stringr::str_remove_all(name, &quot;_dir&quot;) # !!!!!! the folders must be named with this pattern for date extraction to work !!!!!!!!!!!!!!! # !!!!!! could manually make a lookup table.... but ohwell !!!!!!!!!!!!!!! , als_nm = value %&gt;% stringr::str_extract(&quot;(uas_lidar|uas_sfm|als)_(\\\\d{4})&quot;) , nm = stringr::str_c( study_site , dplyr::coalesce(als_nm, name) , sep = &quot;_&quot; ) ) # directory with the downloaded .las|.laz files study_sites_las_ctg &lt;- 1:nrow(las_df_temp) %&gt;% purrr::map(\\(x) lidR::readLAScatalog(las_df_temp$value[x]) ) names(study_sites_las_ctg) &lt;- las_df_temp$nm # what are these ctgs? study_sites_las_ctg ## $FortStewart_als_2018 ## class : LAScatalog (v1.4 format 6) ## extent : 1336000, 1340000, 1095000, 1098000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / Conus Albers + NAVD88 height - Geoid12B (Meters) ## area : 9 km² ## points : 43.07 million points ## type : airborne ## density : 4.8 points/m² ## density : 3.1 pulses/m² ## num. files : 9 ## ## $FortStewart_als_2025 ## class : LAScatalog (v1.4 format 6) ## extent : 430500, 434700, 3543200, 3546000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / NAD83(2011) / UTM zone 17N + NAVD88 ## area : 6.86 km² ## points : 340.22 million points ## type : airborne ## density : 49.6 points/m² ## density : 27.8 pulses/m² ## num. files : 14 ## ## $NewJersey_als_2012 ## class : LAScatalog (v1.2 format 1) ## extent : 552848.7, 554163.1, 4409783, 4411353 (xmin, xmax, ymin, ymax) ## coord. ref. : NA ## area : 6.19 kunits² ## points : 80.3 million points ## type : airborne ## density : 13 points/units² ## num. files : 3 ## ## $NewJersey_uas_lidar_2024 ## class : LAScatalog (v1.2 format 3) ## extent : 552586.1, 554255.9, 4409595, 4411461 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83 / UTM zone 18N ## area : 5.62 km² ## points : 758.27 million points ## type : airborne ## density : 134.9 points/m² ## num. files : 4 ## ## $SaltCabin_als_2021 ## class : LAScatalog (v1.4 format 0) ## extent : -801159, -797999, 2001522, 2003352 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83 / Conus Albers ## area : 5.6 km² ## points : 35.22 million points ## type : airborne ## density : 6.3 points/m² ## density : 6.3 pulses/m² ## num. files : 2 ## ## $SaltCabin_uas_sfm_2024 ## class : LAScatalog (v1.2 format 3) ## extent : 453536.8, 454139, 4501977, 4502440 (xmin, xmax, ymin, ymax) ## coord. ref. : WGS 84 / UTM zone 13N ## area : 278704 m² ## points : 94.51 million points ## type : terrestrial ## density : 339.1 points/m² ## num. files : 1 ## ## $SycanMarsh_als_2021 ## class : LAScatalog (v1.4 format 6) ## extent : 651000, 653000, 4747000, 4748000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / UTM zone 10N + NAVD88 height - Geoid18 (m) ## area : 2 km² ## points : 68.02 million points ## type : airborne ## density : 34 points/m² ## density : 25.6 pulses/m² ## num. files : 2 ## ## $SycanMarsh_uas_lidar_2023 ## class : LAScatalog (v1.2 format 3) ## extent : 651487, 652298.4, 4747227, 4747880 (xmin, xmax, ymin, ymax) ## coord. ref. : WGS 84 / UTM zone 10N ## area : 0.53 km² ## points : 200.55 million points ## type : terrestrial ## density : 378.3 points/m² ## density : 350.8 pulses/m² ## num. files : 1 plot the point cloud catalog with the stand boundary ggplot2::ggplot() + ggplot2::geom_sf( data = study_sites_sf %&gt;% dplyr::slice(1) , color = &quot;navy&quot;, fill = NA ) + ggplot2::geom_sf( data = study_sites_las_ctg[[1]]$geometry %&gt;% sf::st_transform(sf::st_crs(study_sites_sf)) , color = &quot;gray33&quot;, fill = NA ) + ggplot2::theme_light() # lidR::st_crs(ctg_temp[[3]]) let’s make a quick function to grab a background map (e.g. like a Google Map) for an AOI using the ggmap package library(ggmap) library(ggspatial) ######################################################################### ######################################################################### # Make each plot individually by landscape as solution to small multiples # this block defines function ######################################################################### ##################hack to align plots for ggmap ggmap_bbox_fn &lt;- function(map, my_crs=3857) { if (!inherits(map, &quot;ggmap&quot;)) stop(&quot;map must be a ggmap object&quot;) # Extract the bounding box (in lat/lon) from the ggmap to a numeric vector, # and set the names to what sf::st_bbox expects: map_bbox &lt;- setNames(unlist(attr(map, &quot;bb&quot;)), c(&quot;ymin&quot;, &quot;xmin&quot;, &quot;ymax&quot;, &quot;xmax&quot;)) # Convert the bbox to an sf polygon, transform it to 3857, # and convert back to a bbox (convoluted, but it works) bbox_3857 &lt;- st_bbox(st_transform(st_as_sfc(st_bbox(map_bbox, crs = 4326)), my_crs)) # Overwrite the bbox of the ggmap object with the transformed coordinates attr(map, &quot;bb&quot;)$ll.lat &lt;- bbox_3857[&quot;ymin&quot;] attr(map, &quot;bb&quot;)$ll.lon &lt;- bbox_3857[&quot;xmin&quot;] attr(map, &quot;bb&quot;)$ur.lat &lt;- bbox_3857[&quot;ymax&quot;] attr(map, &quot;bb&quot;)$ur.lon &lt;- bbox_3857[&quot;xmax&quot;] map } plt_crs &lt;- 3857 ######################################################################### ######################################################################### # for google maps... have to: # 1) get api key at https://console.cloud.google.com/apis/dashboard # 2) run ggmap::register_google(key = &quot;mykey_xxxxxxxxx&quot;, write = T) ######################################################################### my_ggmap_basemap &lt;- function( sf_data , zoom_level = 14 # from 3 (continent) to 21 (building), default value 10 (city) , buffer_box = 2600 , my_crs = plt_crs , scale_location = &quot;bl&quot; , my_maptype = &quot;stamen_terrain&quot; ## stamen # stamen_terrain, stamen_toner, stamen_toner_lite, stamen_watercolor, stamen_terrain_background # , stamen_toner_background, stamen_terrain_lines, stamen_terrain_labels # , stamen_toner_lines, stamen_toner_labels ## googlmap # &quot;terrain&quot;, &quot;satellite&quot;, &quot;roadmap&quot;, and &quot;hybrid&quot; , add_sf_data = F , outline_sf_data_col = &quot;white&quot; , outline_lwd = 0.7 ) { # # should zoom in? # zoom_level &lt;- 14 # 11 # # should buffer extend? # buffer_box &lt;- 2600 # 20000 # bounding box bb_temp &lt;- sf_data %&gt;% sf::st_bbox() %&gt;% sf::st_as_sfc() %&gt;% sf::st_transform(crs=5070) %&gt;% sf::st_buffer(as.numeric(buffer_box)) %&gt;% sf::st_transform(crs=4326) center_temp &lt;- sf::st_centroid(bb_temp) %&gt;% sf::st_coordinates() %&gt;% .[1,] # set bbox for get call bb_temp &lt;- sf::st_bbox(bb_temp) bbox_temp &lt;- c( bottom = bb_temp[[2]] , top = bb_temp[[4]] , right = bb_temp[[3]] , left = bb_temp[[1]] ) # ggmap::get_stadiamap vs ggmap::get_googlemap if( tolower(my_maptype) %in% c(&quot;terrain&quot;, &quot;satellite&quot;, &quot;roadmap&quot;, &quot;hybrid&quot;) ){ is_google &lt;- T hey_ggmap &lt;- ggmap::get_googlemap( center = center_temp , zoom = zoom_level , maptype = tolower(my_maptype) , crop = T ) }else{ is_google &lt;- F hey_ggmap &lt;- ggmap::get_stadiamap( bbox = bbox_temp , zoom = zoom_level , maptype = tolower(my_maptype) #&quot;stamen_terrain&quot; #&quot;stamen_toner_lite&quot; , crop = T ) # ggmap::ggmap(hey_ggmap) # apply align function hey_ggmap &lt;- ggmap_bbox_fn(hey_ggmap, my_crs) # Use the function } # plot plt_basemap &lt;- ggmap::ggmap(hey_ggmap) + ggplot2::coord_sf( expand = FALSE ) + ggplot2::theme_light() + ggplot2::theme( legend.position = &quot;none&quot; , plot.title = ggplot2::element_blank() , strip.text = ggplot2::element_blank() , axis.title = ggplot2::element_blank() , axis.text = ggplot2::element_blank() , axis.ticks = ggplot2::element_blank() , panel.grid = ggplot2::element_blank() , plot.margin = ggplot2::margin(0, 0, 0, 0, &quot;cm&quot;) ) ### add data? if(scale_location %in% c(&quot;bl&quot;, &quot;br&quot;, &quot;tr&quot;, &quot;tl&quot;)){ plt_basemap &lt;- plt_basemap + ggspatial::annotation_scale( location = scale_location , style = &quot;ticks&quot; , pad_x = unit(0.1, &quot;cm&quot;) , pad_y = unit(0.1, &quot;cm&quot;) ) } if(add_sf_data){ if(is_google){ plt_basemap &lt;- plt_basemap + ggplot2::geom_sf( data = sf_data %&gt;% sf::st_transform(4326) , fill = NA, color = outline_sf_data_col, lwd = outline_lwd , inherit.aes = F ) # ggplot2::geom_path( # data = sf_data %&gt;% # sf::st_transform(4326) %&gt;% # st_coordinates() %&gt;% # as.data.frame() %&gt;% # dplyr::mutate(lon = X, lat = Y) %&gt;% # sf::st_as_sf(coords = c(&quot;X&quot;,&quot;Y&quot;), crs = 4326) # , fill = NA, color = outline_sf_data_col # , inherit.aes = F # ) }else{ plt_basemap &lt;- plt_basemap + ggplot2::geom_sf( data = sf_data %&gt;% sf::st_transform(crs=plt_crs) , fill = NA, color = outline_sf_data_col, lwd = outline_lwd , inherit.aes = F ) } } return(plt_basemap) } make a function specific to this data and task to grab the basemap with my_ggmap_basemap() and overlay the point cloud data and the study area bounds plt_fn_temp &lt;- function( record_study_sites_las_ctg , my_study_sites_las_ctg = study_sites_las_ctg , my_study_sites_sf = study_sites_sf # , zoom_level = 14, buffer_box = 2600, my_crs = plt_crs, scale_location = &quot;bl&quot;, my_maptype = &quot;stamen_terrain&quot; ) { # make a function to grab the basemap with my_ggmap_basemap, and overlay the point cloud data and the study area bounds plt_basemap_temp &lt;- my_ggmap_basemap( sf_data = my_study_sites_las_ctg[[record_study_sites_las_ctg]]$geometry , zoom_level = 14 , buffer_box = 3333 , my_crs = plt_crs , scale_location = &quot;bl&quot; , my_maptype = &quot;stamen_terrain&quot; ) # plot plt2_temp &lt;- plt_basemap_temp + ggplot2::geom_sf( data = my_study_sites_las_ctg[[record_study_sites_las_ctg]]$geometry %&gt;% sf::st_transform(crs=plt_crs) , fill = NA, lwd = 0.7, color = &quot;gray8&quot; , inherit.aes = F ) + ggplot2::geom_sf( data = my_study_sites_sf %&gt;% dplyr::filter( study_site %in% (my_study_sites_las_ctg[record_study_sites_las_ctg] %&gt;% names() %&gt;% stringr::word(sep = &quot;_&quot;)) ) %&gt;% sf::st_transform(crs=plt_crs) , fill = NA, color = &quot;navy&quot;, lwd = 1.4 , inherit.aes = F ) + ggplot2::labs( subtitle = paste0( my_study_sites_sf %&gt;% dplyr::filter( study_site %in% (my_study_sites_las_ctg[record_study_sites_las_ctg] %&gt;% names() %&gt;% stringr::word(sep = &quot;_&quot;)) ) %&gt;% dplyr::pull(study_site_lab) , &quot; - &quot; , (my_study_sites_las_ctg[record_study_sites_las_ctg] %&gt;% names() %&gt;% stringr::str_replace_all(&quot;_&quot;,&quot; &quot;) %&gt;% stringr::str_replace(&quot;^\\\\S+\\\\s*&quot;, &quot;&quot;) %&gt;% toupper() ) , &quot; data&quot; ) ) return( plt2_temp ) } # for each las ctg with crs sf::st_crs(study_sites_las_ctg$NewJersey_als_2012) &lt;- paste0(&quot;EPSG:&quot;, 32618) # D; plts_temp &lt;- 1:length(study_sites_las_ctg %&gt;% purrr::discard(names(.) %in% c(&quot;FortStewart_uas_lidar&quot;,&quot;NewJersey_als&quot;))) %&gt;% purrr::map( \\(x) plt_fn_temp( record_study_sites_las_ctg = x , my_study_sites_las_ctg = study_sites_las_ctg %&gt;% purrr::discard(names(.) %in% c(&quot;FortStewart_uas_lidar&quot;,&quot;NewJersey_als&quot;)) , ) ) # patchwork it patchwork::wrap_plots(plts_temp, ncol = 2) # 2.3 ITD window functions # set up initial list with default functions my_ws_functions &lt;- cloud2trees::itd_ws_functions() # add to list my_ws_functions$log_les_ccv_fn &lt;- function (x) { y &lt;- dplyr::case_when( is.na(x) ~ 0.001 , x &lt; 0 ~ 0.001 , x &gt; exp(5)-1 ~ 5 , TRUE ~ log(x+1) ) return(y) } # add to list my_ws_functions$log_mor_ccv_fn &lt;- function (x) { y &lt;- dplyr::case_when( is.na(x) ~ 0.001 , x &lt; 0 ~ 0.001 , x &gt; exp(7/1.5)-1 ~ 7 , TRUE ~ 1.5*log(x+1) ) return(y) } # add to list my_ws_functions$lin_lo_slp_fn &lt;- function (x) { y &lt;- dplyr::case_when( is.na(x) ~ 0.001 , x &lt; 0 ~ 0.001 , x &gt; (4-0.75)/0.04 ~ 4 , TRUE ~ 0.75 + (x * 0.04) ) return(y) } run each function over a range of heights to see what they return on a plot # get ws by ht for each fn ws_fn_df &lt;- 1:length(my_ws_functions) %&gt;% purrr::map(function(x){ nm &lt;- my_ws_functions[x] %&gt;% names() %&gt;% as.character() fn &lt;- my_ws_functions[[x]] # est height &lt;- seq(from=0,to=60,by=0.5) ws &lt;- fn(height) %&gt;% unlist() df &lt;- dplyr::tibble( height = height , ws = ws ) %&gt;% dplyr::mutate(ws_fn_nm = nm) %&gt;% dplyr::relocate(ws_fn_nm) return(df) }) %&gt;% dplyr::bind_rows() # huh? ws_fn_df %&gt;% dplyr::glimpse() ## Rows: 726 ## Columns: 3 ## $ ws_fn_nm &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;… ## $ height &lt;dbl&gt; 0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6… ## $ ws &lt;dbl&gt; 1.00, 1.00, 1.00, 1.00, 1.03, 1.10, 1.17, 1.24, 1.31, 1.38, 1… plot of all ITD variable window functions for testing ws_fn_df %&gt;% ggplot2::ggplot(mapping = ggplot2::aes(x = height, y = ws, color = ws_fn_nm)) + ggplot2::geom_line(lwd=1) + # ggplot2::scale_color_manual(values = pal_ws) + # ggplot2::scale_color_viridis_d(option = &quot;turbo&quot;) + ggplot2::scale_color_brewer(palette = &quot;Dark2&quot;) + ggplot2::xlim(-3,NA) + ggplot2::ylim(-0.1,NA) + ggplot2::labs( x = &quot;heights&quot;, y = &quot;ws&quot; , color = &quot;variable\\nwindow\\nfunction&quot; , subtitle = &quot;ITD variable window functions for testing&quot; ) + ggplot2::theme_light() + ggplot2::guides( color = ggplot2::guide_legend(override.aes = list(lwd = 6)) ) 2.4 Other plotting functions function to plot raster with vector data overlaid plt_rast_poly_fn &lt;- function( rast , poly , crop = T , mask = F , buff = 22 , col = &quot;red&quot; , lwd = 1 , title = &quot;&quot; , leg_pos = &quot;top&quot; ) { if(crop){ rast &lt;- rast %&gt;% terra::crop( poly %&gt;% sf::st_buffer(buff) %&gt;% sf::st_transform(terra::crs(rast)) %&gt;% terra::vect() ) } if(mask){ rast &lt;- rast %&gt;% terra::mask( poly %&gt;% sf::st_buffer(buff) %&gt;% sf::st_transform(terra::crs(rast)) %&gt;% terra::vect() ) } # Convert SpatRaster to a data frame for ggplot rast_df &lt;- terra::as.data.frame(rast, xy=TRUE) %&gt;% rename(f=3) # Create the base raster plot p &lt;- ggplot2::ggplot() + ggplot2::geom_raster( data = rast_df, aes(x = x, y = y, fill = f) ) + # ggplot2::scale_fill_viridis_c() + # Use a colorblind-friendly palette # ggplot2::coord_sf(crs = terra::crs(rast)) + # Match the CRS ggplot2::labs(fill = &quot;&quot;) + ggplot2::theme_void() + ggplot2::theme( legend.position = leg_pos , legend.text = ggplot2::element_text(angle = 90, vjust = 0.5, size = 7) , plot.subtitle = ggplot2::element_text(hjust = 0.5) # , plot.title = ggplot2::element_text(hjust = 0.5) ) # Add the polygon overlay p &lt;- p + ggplot2::geom_sf( data = poly %&gt;% sf::st_transform(terra::crs(rast)) , fill = NA, color = col, lwd = lwd ) + ggplot2::labs(subtitle = title) return(p) } ##### plt_crown_attr_fn &lt;- function( crowns , aoi , col = &quot;navy&quot; , lwd = 1 , title = &quot;&quot; , leg_pos = &quot;top&quot; # polygon attrs , fill_var , palette = &quot;Blues&quot; # see ggplot2::scale_fill_distiller ) { ggplot2::ggplot( data = aoi %&gt;% sf::st_transform(sf::st_crs(crowns)) ) + ggplot2::geom_sf(fill = NA, color = col, lwd = lwd) + ggplot2::geom_sf( data = crowns %&gt;% sf::st_intersection( aoi %&gt;% sf::st_transform(sf::st_crs(crowns)) ) , mapping = ggplot2::aes(fill = .data[[fill_var]]) , color = NA ) + ggplot2::scale_fill_distiller(palette = palette, name = title, direction = 1, labels = scales::comma_format(accuracy = 1)) + ggplot2::theme_void() + ggplot2::theme( legend.position = leg_pos , legend.direction = &quot;horizontal&quot; , legend.title = ggplot2::element_text(size = 7) , legend.text = ggplot2::element_text(size = 6) ) } # load our FIA forest type group raster for use later # load lookup foresttype_lookup &lt;- file.path(cloud2trees::find_ext_data()[[&quot;foresttype_dir&quot;]], &quot;foresttype_lookup.csv&quot;) %&gt;% readr::read_csv(progress = F, show_col_types = F) %&gt;% dplyr::distinct(forest_type_group_code, forest_type_group, hardwood_softwood) %&gt;% dplyr::mutate(forest_type_group = stringr::str_remove(forest_type_group, &quot; group&quot;)) # forest type group summary foresttype_sum_fn &lt;- function(crowns, aoi, unit) { crowns %&gt;% sf::st_intersection( aoi %&gt;% sf::st_transform(sf::st_crs(crowns)) ) %&gt;% sf::st_drop_geometry() %&gt;% dplyr::mutate(unit_name = unit) %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(unit_name, forest_type_group) %&gt;% dplyr::arrange(unit_name, desc(n)) %&gt;% dplyr::group_by(unit_name) %&gt;% dplyr::mutate( pct = scales::percent(n/sum(n), accuracy = 0.1) ) %&gt;% dplyr::ungroup() %&gt;% dplyr::mutate(n = scales::comma(n,accuracy=1)) %&gt;% kableExtra::kbl( caption = &quot;Count of trees by FIA Forest Type Group&quot; , digits = 2 , col.names = c( &quot;.&quot; , &quot;&quot; , &quot;# trees&quot; , &quot;% trees&quot; ) ) %&gt;% kableExtra::kable_styling() %&gt;% kableExtra::collapse_rows(columns = 1, valign = &quot;top&quot;) } # summarize tree metrics stats_sum_fn &lt;- function(crowns, aoi, unit) { crowns %&gt;% sf::st_intersection( aoi %&gt;% sf::st_transform(sf::st_crs(crowns)) ) %&gt;% sf::st_drop_geometry() %&gt;% dplyr::mutate(unit_name = unit) %&gt;% dplyr::group_by( unit_name) %&gt;% dplyr::summarise( dplyr::across( c(tree_height_m, dbh_cm, tree_cbh_m, max_crown_diam_height_m, cruz_tree_kg_per_m3, landfire_tree_kg_per_m3) , .fns = list(mean = mean, median = median, sd = sd, min = min, max = max) ) , n = dplyr::n() ) %&gt;% dplyr::ungroup() %&gt;% tidyr::pivot_longer(cols = -c( unit_name,n)) %&gt;% dplyr::mutate( agg = stringr::word(name,-1,sep = &quot;_&quot;) , metric = stringr::str_remove_all(name, paste0(&quot;_&quot;,agg)) ) %&gt;% dplyr::select(-name) %&gt;% dplyr::mutate( value = dplyr::case_when( metric == &quot;tree_height_m&quot; ~ scales::comma(value,accuracy=0.1) , metric == &quot;dbh_cm&quot; ~ scales::comma(value,accuracy=0.1) , metric == &quot;tree_cbh_m&quot; ~ scales::comma(value,accuracy=0.1) , metric == &quot;max_crown_diam_height_m&quot; ~ scales::comma(value,accuracy=0.1) , metric == &quot;cruz_tree_kg_per_m3&quot; ~ scales::comma(value,accuracy=0.001) , metric == &quot;landfire_tree_kg_per_m3&quot; ~ scales::comma(value,accuracy=0.001) , T ~ scales::comma(value,accuracy=0.1) ) ) %&gt;% tidyr::pivot_wider(names_from = agg, values_from = value) %&gt;% dplyr::mutate( unit_lab = paste0( unit_name ,&quot;&lt;br&gt;(&quot; , scales::comma(n,accuracy=1) ,&quot; trees)&quot; ) , range = paste0(min, &quot;—&quot;, max) ) %&gt;% dplyr::arrange( unit_name, desc(n)) %&gt;% dplyr::select(-c(unit_name,n,min,max)) %&gt;% dplyr::relocate(unit_lab) %&gt;% dplyr::mutate( metric = factor( metric , ordered = T , levels = c( &quot;tree_height_m&quot; , &quot;dbh_cm&quot; , &quot;tree_cbh_m&quot; , &quot;max_crown_diam_height_m&quot; , &quot;cruz_tree_kg_per_m3&quot; , &quot;landfire_tree_kg_per_m3&quot; ) , labels = c( &quot;Height (m)&quot; , &quot;DBH (cm)&quot; , &quot;Crown Base Ht. (m)&quot; , &quot;HMD (m)&quot; , &quot;Cruz CBD&lt;br&gt;kg m&lt;sup&gt;-3&lt;/sup&gt;&quot; , &quot;LANDFIRE CBD&lt;br&gt;kg m&lt;sup&gt;-3&lt;/sup&gt;&quot; ) ) ) %&gt;% kableExtra::kbl( caption = &quot;Summary statistics for selected metrics&quot; , col.names = c( &quot;Unit Name&quot;, &quot;Metric&quot; , &quot;Mean&quot;, &quot;Median&quot; , &quot;Std Dev&quot;, &quot;Range&quot; ) , escape = F # , digits = 2 ) %&gt;% kableExtra::kable_styling(font_size = 13) %&gt;% kableExtra::collapse_rows(columns = 1, valign = &quot;top&quot;) } "],["sycan-marsh-or.html", "Section 3 Sycan Marsh (OR) 3.1 ALS Processing 3.2 UAS lidar Processing", " Section 3 Sycan Marsh (OR) process the point cloud data for the Sycan Marsh (OR) study site let’s check out the data we have and the area # just get the data we care about aoi_study_site &lt;- &quot;SycanMarsh&quot; aoi_sf &lt;- study_sites_sf %&gt;% dplyr::filter(study_site == aoi_study_site) aoi_las_ctg &lt;- study_sites_las_ctg %&gt;% purrr::keep_at( names(study_sites_las_ctg)[ stringr::str_detect(names(study_sites_las_ctg), aoi_study_site) ] ) # option to put satellite imagery as base layer of mapview maps mapview::mapviewOptions( homebutton = FALSE , basemaps = c(&quot;Esri.WorldImagery&quot;,&quot;OpenStreetMap&quot;) ) # map it # add the study bounds mapview::mapview( aoi_las_ctg[[1]]$geometry , color = &quot;black&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[1]) , legend = F , popup = F ) + mapview::mapview( aoi_las_ctg[[2]]$geometry , color = &quot;gray&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[2]) , legend = F , popup = F ) + mapview::mapview( aoi_sf , zcol = &quot;study_site_lab&quot; , color = &quot;navy&quot; , lwd = 2 , alpha.regions = 0 , legend = T , popup = F ) point cloud data summary aoi_las_ctg ## $SycanMarsh_als_2021 ## class : LAScatalog (v1.4 format 6) ## extent : 651000, 653000, 4747000, 4748000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / UTM zone 10N + NAVD88 height - Geoid18 (m) ## area : 2 km² ## points : 68.02 million points ## type : airborne ## density : 34 points/m² ## density : 25.6 pulses/m² ## num. files : 2 ## ## $SycanMarsh_uas_lidar_2023 ## class : LAScatalog (v1.2 format 3) ## extent : 651487, 652298.4, 4747227, 4747880 (xmin, xmax, ymin, ymax) ## coord. ref. : WGS 84 / UTM zone 10N ## area : 0.53 km² ## points : 200.55 million points ## type : terrestrial ## density : 378.3 points/m² ## density : 350.8 pulses/m² ## num. files : 1 3.1 ALS Processing 3.1.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;SycanMarsh_als_2021&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_SycanMarsh_als.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 2 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_SycanMarsh_als.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 6, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$exp_fn 3.1.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;als_2021_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 3.1.3 cloud2trees Results 3.1.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 3.1: Count of trees by FIA Forest Type Group . # trees % trees Sycan Marsh (OR) Ponderosa pine group 4,291 100.0% 3.1.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 3.1.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 3.1.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date we’ll sample the trees here so the output can be seen more clearly plt_aoi_basemap &lt;- my_ggmap_basemap( sf_data = aoi_sf , zoom_level = 16 , buffer_box = 22 , my_maptype = &quot;satellite&quot; , add_sf_data = T , outline_sf_data_col = &quot;navy&quot; , outline_lwd = 1 ) # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 3.1.3.5 Tree Attributes Spatial plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = cloud2trees_ans$crowns_sf , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 3.1.3.6 Tree Attributes Summary Stats stats_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) Table 3.2: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Sycan Marsh (OR) - ALS(4,291 trees) Height (m) 12.7 12.8 6.0 2.0—33.8 DBH (cm) 24.3 23.1 13.7 3.6—79.0 Crown Base Ht. (m) 3.8 3.8 1.1 1.5—15.5 HMD (m) 5.3 5.5 1.8 0.0—18.5 Cruz CBDkg m-3 0.421 0.414 0.116 0.107—1.253 LANDFIRE CBDkg m-3 0.216 0.200 0.130 0.057—1.953 3.2 UAS lidar Processing 3.2.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;SycanMarsh_uas_lidar_2023&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_SycanMarsh_uas_lidar.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 2 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_SycanMarsh_uas_lidar.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 6, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$lin_fn 3.2.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;uas_lidar_2023_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 3.2.3 cloud2trees Results 3.2.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 3.3: Count of trees by FIA Forest Type Group . # trees % trees Sycan Marsh (OR) Ponderosa pine group 4,473 100.0% 3.2.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) 3.2.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) 3.2.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date we’ll sample the trees here so the output can be seen more clearly # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 3.2.3.5 Tree Attributes Spatial plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = cloud2trees_ans$crowns_sf , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 3.2.3.6 Tree Attributes Summary Stats stats_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) Table 3.4: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Sycan Marsh (OR) - UAS Lidar(4,473 trees) Height (m) 11.5 11.3 6.9 2.0—34.2 DBH (cm) 22.4 19.9 15.7 3.6—82.0 Crown Base Ht. (m) 4.1 4.0 1.6 1.5—14.5 HMD (m) 4.8 4.7 2.7 0.1—16.6 Cruz CBDkg m-3 0.299 0.289 0.099 0.090—1.852 LANDFIRE CBDkg m-3 0.147 0.134 0.075 0.052—1.188 "],["fort-stewart-ga.html", "Section 4 Fort Stewart (GA) 4.1 ALS (2018) Processing 4.2 ALS (2025) Processing", " Section 4 Fort Stewart (GA) process the point cloud data for the Fort Stewart (GA) study site let’s check out the data we have and the area # just get the data we care about aoi_study_site &lt;- &quot;FortStewart&quot; aoi_sf &lt;- study_sites_sf %&gt;% dplyr::filter(study_site == aoi_study_site) aoi_las_ctg &lt;- study_sites_las_ctg %&gt;% purrr::keep_at( names(study_sites_las_ctg)[ stringr::str_detect(names(study_sites_las_ctg), aoi_study_site) ] ) # option to put satellite imagery as base layer of mapview maps mapview::mapviewOptions( homebutton = FALSE , basemaps = c(&quot;Esri.WorldImagery&quot;,&quot;OpenStreetMap&quot;) ) # map it # add the study bounds mapview::mapview( aoi_las_ctg[[1]]$geometry , color = &quot;black&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[1]) , legend = F , popup = F ) + mapview::mapview( aoi_las_ctg[[2]]$geometry , color = &quot;gray&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[2]) , legend = F , popup = F ) + mapview::mapview( aoi_sf , zcol = &quot;study_site_lab&quot; , color = &quot;navy&quot; , lwd = 2 , alpha.regions = 0 , legend = T , popup = F ) point cloud data summary aoi_las_ctg ## $FortStewart_als_2018 ## class : LAScatalog (v1.4 format 6) ## extent : 1336000, 1340000, 1095000, 1098000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / Conus Albers + NAVD88 height - Geoid12B (Meters) ## area : 9 km² ## points : 43.07 million points ## type : airborne ## density : 4.8 points/m² ## density : 3.1 pulses/m² ## num. files : 9 ## ## $FortStewart_als_2025 ## class : LAScatalog (v1.4 format 6) ## extent : 430500, 434700, 3543200, 3546000 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83(2011) / NAD83(2011) / UTM zone 17N + NAVD88 ## area : 6.86 km² ## points : 340.22 million points ## type : airborne ## density : 49.6 points/m² ## density : 27.8 pulses/m² ## num. files : 14 4.1 ALS (2018) Processing 4.1.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;FortStewart_als_2018&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_FortStewart_als.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions , chm_res_m = 0.3 ) ggplot2::ggsave( &quot;../data/itd_tuning_FortStewart_als.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 7, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$exp_fn 4.1.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;als_2018_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.3 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.3m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 4.1.3 cloud2trees Results 4.1.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 4.1: Count of trees by FIA Forest Type Group . # trees % trees Fort Stewart (GA) Loblolly / shortleaf pine group 95,880 62.7% Longleaf / slash pine group 30,686 20.1% Oak / gum / cypress group 26,376 17.2% Oak / pine group 43 0.0% 4.1.3.2 DTM this is a large area so we’re going to make the raster more coarse plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;)) this is lowland 4.1.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray this is a large area so we’re going to make the raster more coarse and sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.1) plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = crowns_temp %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.1 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;)) 4.1.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date this is a large area so we’re going to zoom way in on the image and sample from the tree list plt_aoi_basemap &lt;- my_ggmap_basemap( sf_data = aoi_sf %&gt;% sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) , zoom_level = 17 , buffer_box = 22 , my_maptype = &quot;satellite&quot; , add_sf_data = F ) # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% sf::st_intersection( aoi_sf %&gt;% # sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 4.1.3.5 Tree Attributes Spatial this is a large area so we’re going to sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.2) plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = crowns_temp , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 4.1.3.6 Tree Attributes Summary Stats stats_sum_fn( crowns = cloud2trees_ans$crowns_sf %&gt;% ## !!!!!!!!!!!!!!!!!!!!!!!! cruz_tree_kg_per_m3 empty here dplyr::mutate(cruz_tree_kg_per_m3 = as.numeric(NA)) , aoi = aoi_sf , unit = paste0(aoi_sf$study_site_lab, &quot; - ALS 2018&quot;) ) Table 4.2: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Fort Stewart (GA) - ALS 2018(152,985 trees) Height (m) 17.5 18.7 6.2 2.0—38.4 DBH (cm) 22.1 23.0 8.9 3.4—67.6 Crown Base Ht. (m) 11.4 12.4 3.6 1.5—25.5 HMD (m) 9.8 10.6 3.6 0.1—27.1 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.235 0.251 0.119 0.005—1.278 4.2 ALS (2025) Processing 4.2.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;FortStewart_als_2025&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/FortStewart_als_2025.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions , chm_res_m = 0.25 ) ggplot2::ggsave( &quot;../data/FortStewart_als_2025.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 7, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$exp_fn 4.2.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;als_2025_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 4.2.3 cloud2trees Results 4.2.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 4.3: Count of trees by FIA Forest Type Group . # trees % trees Fort Stewart (GA) Loblolly / shortleaf pine group 44,680 60.2% Oak / gum / cypress group 17,110 23.0% Longleaf / slash pine group 12,458 16.8% Oak / pine group 15 0.0% 4.2.3.2 DTM this is a large area so we’re going to make the raster more coarse plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;)) this is lowland 4.2.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray this is a large area so we’re going to make the raster more coarse and sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.2) plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = crowns_temp %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.1 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;)) 4.2.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date this is a large area so we’re going to zoom way in on the image and sample from the tree list plt_aoi_basemap &lt;- my_ggmap_basemap( sf_data = aoi_sf %&gt;% sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) , zoom_level = 17 , buffer_box = 22 , my_maptype = &quot;satellite&quot; , add_sf_data = F ) # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% sf::st_intersection( aoi_sf %&gt;% # sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 4.2.3.5 Tree Attributes Spatial this is a large area so we’re going to sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.4) plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = crowns_temp , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 4.2.3.6 Tree Attributes Summary Stats stats_sum_fn( crowns = cloud2trees_ans$crowns_sf %&gt;% ## !!!!!!!!!!!!!!!!!!!!!!!! cruz_tree_kg_per_m3 empty here dplyr::mutate(cruz_tree_kg_per_m3 = as.numeric(NA)) , aoi = aoi_sf , unit = paste0(aoi_sf$study_site_lab, &quot; - ALS 2025&quot;) ) Table 4.4: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Fort Stewart (GA) - ALS 2025(74,263 trees) Height (m) 19.0 20.5 6.5 2.0—36.9 DBH (cm) 24.9 26.3 9.7 3.4—64.0 Crown Base Ht. (m) 9.4 10.0 3.0 1.5—24.5 HMD (m) 10.2 10.8 4.1 0.1—27.8 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.358 0.336 0.224 0.009—1.931 "],["salt-cabin-co.html", "Section 5 Salt Cabin (CO) 5.1 ALS Processing 5.2 UAS sfm Processing", " Section 5 Salt Cabin (CO) process the point cloud data for the Salt Cabin (CO) study site let’s check out the data we have and the area # just get the data we care about aoi_study_site &lt;- &quot;SaltCabin&quot; aoi_sf &lt;- study_sites_sf %&gt;% dplyr::filter(study_site == aoi_study_site) aoi_las_ctg &lt;- study_sites_las_ctg %&gt;% purrr::keep_at( names(study_sites_las_ctg)[ stringr::str_detect(names(study_sites_las_ctg), aoi_study_site) ] ) # option to put satellite imagery as base layer of mapview maps mapview::mapviewOptions( homebutton = FALSE , basemaps = c(&quot;Esri.WorldImagery&quot;,&quot;OpenStreetMap&quot;) ) # map it # add the study bounds mapview::mapview( aoi_las_ctg[[1]]$geometry , color = &quot;black&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[1]) , legend = F , popup = F ) + mapview::mapview( aoi_las_ctg[[2]]$geometry , color = &quot;gray&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[2]) , legend = F , popup = F ) + mapview::mapview( aoi_sf , zcol = &quot;study_site_lab&quot; , color = &quot;navy&quot; , lwd = 2 , alpha.regions = 0 , legend = T , popup = F ) point cloud data summary aoi_las_ctg ## $SaltCabin_als_2021 ## class : LAScatalog (v1.4 format 0) ## extent : -801159, -797999, 2001522, 2003352 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83 / Conus Albers ## area : 5.6 km² ## points : 35.22 million points ## type : airborne ## density : 6.3 points/m² ## density : 6.3 pulses/m² ## num. files : 2 ## ## $SaltCabin_uas_sfm_2024 ## class : LAScatalog (v1.2 format 3) ## extent : 453536.8, 454139, 4501977, 4502440 (xmin, xmax, ymin, ymax) ## coord. ref. : WGS 84 / UTM zone 13N ## area : 278704 m² ## points : 94.51 million points ## type : terrestrial ## density : 339.1 points/m² ## num. files : 1 5.1 ALS Processing 5.1.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;SaltCabin_als_2021&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_SaltCabin_als.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_SaltCabin_als.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 6, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$log_les_ccv_fn 5.1.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;als_2021_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 5.1.3 cloud2trees Results 5.1.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 5.1: Count of trees by FIA Forest Type Group . # trees % trees Salt Cabin (CO) Ponderosa pine group 5,598 76.5% Aspen / birch group 1,212 16.6% Pinyon / juniper group 194 2.7% Douglas-fir group 157 2.1% Woodland hardwoods group 87 1.2% Fir / spruce / mountain hemlock group 35 0.5% Lodgepole pine group 35 0.5% 5.1.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 5.1.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 5.1.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date we’ll sample the trees here so the output can be seen more clearly plt_aoi_basemap &lt;- my_ggmap_basemap( sf_data = aoi_sf , zoom_level = 16 , buffer_box = 22 , my_maptype = &quot;satellite&quot; , add_sf_data = T , outline_sf_data_col = &quot;navy&quot; , outline_lwd = 1 ) # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 5.1.3.5 Tree Attributes Spatial plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = cloud2trees_ans$crowns_sf , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 5.1.3.6 Tree Attributes Summary Stats stats_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) Table 5.2: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Salt Cabin (CO) - ALS(7,318 trees) Height (m) 7.7 6.7 4.5 2.0—21.6 DBH (cm) 12.5 10.1 7.7 3.6—40.5 Crown Base Ht. (m) 3.4 3.5 0.8 1.5—8.5 HMD (m) 3.3 3.4 1.0 0.2—10.7 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.095 0.088 0.072 0.009—1.458 5.2 UAS sfm Processing 5.2.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;SaltCabin_uas_sfm_2024&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_SaltCabin_uas_sfm.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_SaltCabin_uas_sfm.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 7, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$log_les_ccv_fn 5.2.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;uas_sfm_2024_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 5.2.3 cloud2trees Results 5.2.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 5.3: Count of trees by FIA Forest Type Group . # trees % trees Salt Cabin (CO) Ponderosa pine group 2,756 76.0% Aspen / birch group 633 17.5% Pinyon / juniper group 81 2.2% Douglas-fir group 71 2.0% Woodland hardwoods group 41 1.1% Lodgepole pine group 25 0.7% Fir / spruce / mountain hemlock group 17 0.5% 5.2.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;)) 5.2.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;)) 5.2.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date we’ll sample the trees here so the output can be seen more clearly # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 5.2.3.5 Tree Attributes Spatial plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = cloud2trees_ans$crowns_sf , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 5.2.3.6 Tree Attributes Summary Stats stats_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = paste0(aoi_sf$study_site_lab, &quot; - UAS SfM&quot;)) Table 5.4: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Salt Cabin (CO) - UAS SfM(3,624 trees) Height (m) 9.2 8.4 4.9 2.0—22.5 DBH (cm) 16.4 13.6 10.0 3.7—48.9 Crown Base Ht. (m) 4.3 4.3 1.6 1.5—12.5 HMD (m) 3.8 3.6 1.9 0.1—14.7 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.114 0.108 0.081 0.016—1.307 "],["cedar-bridge-nj.html", "Section 6 Cedar Bridge (NJ) 6.1 ALS Processing 6.2 UAS lidar Processing", " Section 6 Cedar Bridge (NJ) process the point cloud data for the Cedar Bridge (NJ) study site let’s check out the data we have and the area # just get the data we care about aoi_study_site &lt;- &quot;NewJersey&quot; aoi_sf &lt;- study_sites_sf %&gt;% dplyr::filter(study_site == aoi_study_site) aoi_las_ctg &lt;- study_sites_las_ctg %&gt;% purrr::keep_at( names(study_sites_las_ctg)[ stringr::str_detect(names(study_sites_las_ctg), aoi_study_site) ] ) # option to put satellite imagery as base layer of mapview maps mapview::mapviewOptions( homebutton = FALSE , basemaps = c(&quot;Esri.WorldImagery&quot;,&quot;OpenStreetMap&quot;) ) # map it # add the study bounds mapview::mapview( sf::st_set_crs(aoi_las_ctg[[1]]$geometry, value = 32618) , color = &quot;black&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[1]) , legend = F , popup = F ) + mapview::mapview( aoi_las_ctg[[2]]$geometry , color = &quot;gray&quot; , lwd = 2 , alpha.regions = 0 , layer.name = names(aoi_las_ctg[2]) , legend = F , popup = F ) + mapview::mapview( aoi_sf , zcol = &quot;study_site_lab&quot; , color = &quot;navy&quot; , lwd = 2 , alpha.regions = 0 , legend = T , popup = F ) point cloud data summary aoi_las_ctg ## $NewJersey_als_2012 ## class : LAScatalog (v1.2 format 1) ## extent : 552848.7, 554163.1, 4409783, 4411353 (xmin, xmax, ymin, ymax) ## coord. ref. : WGS 84 / UTM zone 18N ## area : 6.19 km² ## points : 80.3 million points ## type : airborne ## density : 13 points/m² ## num. files : 3 ## ## $NewJersey_uas_lidar_2024 ## class : LAScatalog (v1.2 format 3) ## extent : 552586.1, 554255.9, 4409595, 4411461 (xmin, xmax, ymin, ymax) ## coord. ref. : NAD83 / UTM zone 18N ## area : 5.62 km² ## points : 758.27 million points ## type : airborne ## density : 134.9 points/m² ## num. files : 4 6.1 ALS Processing 6.1.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;NewJersey_als_2012&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_NewJersey_als.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_NewJersey_als.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 7, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$log_les_ccv_fn 6.1.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;als_2012_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp ## !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! This data has a missing CRS ;[ ## !!!!! setting new_crs to the epsg code of the crs i was told ## !!!!! The EPSG code for UTM zone 18N in the World Geodetic System of 1984 (WGS 84) is 32618 , new_crs = 32618 , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 6.1.3 cloud2trees Results 6.1.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 6.1: Count of trees by FIA Forest Type Group . # trees % trees Cedar Bridge (NJ) Loblolly / shortleaf pine group 110,466 99.1% Oak / hickory group 545 0.5% Oak / pine group 438 0.4% 6.1.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 6.1.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray this is a large area so we’re going to make the raster more coarse and sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.3) plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) 6.1.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date this is a large area so we’re going to zoom way in on the image and sample from the tree list plt_aoi_basemap &lt;- my_ggmap_basemap( sf_data = aoi_sf , zoom_level = 16 , buffer_box = 22 , my_maptype = &quot;satellite&quot; , add_sf_data = T , outline_sf_data_col = &quot;navy&quot; , outline_lwd = 1 ) # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% # sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 6.1.3.5 Tree Attributes Spatial this is a large area so we’re going to sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.5) plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = crowns_temp , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 6.1.3.6 Tree Attributes Summary Stats stats_sum_fn( crowns = cloud2trees_ans$crowns_sf %&gt;% ## !!!!!!!!!!!!!!!!!!!!!!!! cruz_tree_kg_per_m3 empty here dplyr::mutate(cruz_tree_kg_per_m3 = as.numeric(NA)) , aoi = aoi_sf , unit = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;) ) Table 6.2: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Cedar Bridge (NJ) - ALS(111,449 trees) Height (m) 8.9 9.1 3.6 2.0—33.2 DBH (cm) 15.5 15.2 7.2 3.7—82.0 Crown Base Ht. (m) 3.8 3.8 0.9 1.5—13.5 HMD (m) 4.3 4.5 1.3 0.0—17.1 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.240 0.232 0.092 0.012—1.827 6.2 UAS lidar Processing 6.2.1 ITD tuning put las files in a list # list of all las files las_flist_temp &lt;- aoi_las_ctg[[&quot;NewJersey_uas_lidar_2024&quot;]] %&gt;% purrr::pluck(&quot;data&quot;) %&gt;% dplyr::pull(filename) run tuning # if there is an error with tuning...is it because there are no trees for a given ws_fn? # Caused by error in `dplyr::group_by()`: # ! Must group by variables found in `.data`. # Column `ws_fn` is not found. if(!file.exists(&quot;../data/itd_tuning_NewJersey_uas_lidar.jpg&quot;)){ # tuning itd_tuning_ans &lt;- cloud2trees::itd_tuning( input_las_dir = las_flist_temp , n_samples = 3 , ws_fn_list = my_ws_functions ) ggplot2::ggsave( &quot;../data/itd_tuning_NewJersey_uas_lidar.jpg&quot; , plot = itd_tuning_ans$plot_samples , dpi = &quot;print&quot; , height = 7, width = 10 ) } pick the best function for use in ITD # pick the best function for use in ITD best_ws_fn_temp &lt;- my_ws_functions$log_les_ccv_fn 6.2.2 cloud2trees point cloud processing dir_temp &lt;- file.path(aoi_sf$fdir, &quot;uas_lidar_2024_processing&quot;) if(!dir.exists(dir_temp)){ dir.create(dir_temp) # c2t cloud2trees_ans &lt;- cloud2trees::cloud2trees( input_las_dir = las_flist_temp , output_dir = dir_temp , ws = best_ws_fn_temp , dtm_res_m = 1 , chm_res_m = 0.25 , estimate_tree_dbh = T , estimate_tree_type = T # hmd , estimate_tree_hmd = T , hmd_tree_sample_prop = 0.5 , hmd_estimate_missing_hmd = T # biomass , estimate_biomass_method = c(&quot;landfire&quot;,&quot;cruz&quot;) # cbh , estimate_tree_cbh = T , cbh_tree_sample_prop = 0.5 , cbh_estimate_missing_cbh = T ) # add foresttype cloud2trees_ans$foresttype_rast &lt;- terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) }else{ cloud2trees_ans &lt;- list( &quot;dtm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;dtm_1m.tif&quot;) ) , &quot;chm_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;chm_0.25m.tif&quot;) ) , &quot;crowns_sf&quot; = list.files( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;) , pattern = &quot;final_detected_crowns.*\\\\.gpkg$&quot; , full.names = T ) %&gt;% normalizePath() %&gt;% purrr::map(\\(x) sf::st_read( dsn = x , quiet = T ) ) %&gt;% dplyr::bind_rows() , &quot;foresttype_rast&quot; = terra::rast( file.path(dir_temp, &quot;point_cloud_processing_delivery&quot;, &quot;fia_foresttype_raster.tif&quot;) ) %&gt;% terra::subst(from = foresttype_lookup$forest_type_group_code, to = foresttype_lookup$forest_type_group) ) } 6.2.3 cloud2trees Results 6.2.3.1 FIA Forest Type Group # load raster plt_rast_poly_fn( rast = cloud2trees_ans$foresttype_rast , poly = aoi_sf , title = &quot;FIA forest type group&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.8) + # harrypotter::scale_fill_hp_d(option = &quot;lunalovegood&quot;, alpha = 0.8) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) + ggplot2::theme( legend.text = ggplot2::element_text(size = 7, angle = 0) ) distribution by forest type foresttype_sum_fn(crowns = cloud2trees_ans$crowns_sf, aoi = aoi_sf, unit = aoi_sf$study_site_lab[1]) Table 6.3: Count of trees by FIA Forest Type Group . # trees % trees Cedar Bridge (NJ) Loblolly / shortleaf pine group 69,541 98.8% Oak / hickory group 465 0.7% Oak / pine group 347 0.5% 6.2.3.2 DTM plt_rast_poly_fn( rast = cloud2trees_ans$dtm_rast , poly = aoi_sf , title = &quot;DTM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + harrypotter::scale_fill_hp( option = &quot;mischief&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) 6.2.3.3 CHM plot the CHM and we’ll also add the extracted trees in gray this is a large area so we’re going to make the raster more coarse and sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.3) plt_rast_poly_fn( rast = cloud2trees_ans$chm_rast %&gt;% terra::aggregate(fact = 2, cores = lasR::half_cores()) , poly = aoi_sf , title = &quot;CHM (m)&quot; , crop = T , buff = 22 , col = &quot;navy&quot; ) + ggplot2::scale_fill_viridis_c( option = &quot;plasma&quot;, alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6) ) + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.1) %&gt;% sf::st_intersection( aoi_sf %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) , fill = NA, color = &quot;gray33&quot;, lwd = 0.5 ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) 6.2.3.4 Imagery let’s check the tree extraction results (gray) on satellite imagery with a collection date that may not coincide with the point cloud collection date this is a large area so we’re going to zoom way in on the image and sample from the tree list # add crowns plt_aoi_basemap + ggplot2::geom_sf( data = crowns_temp %&gt;% # cloud2trees_ans$crowns_sf %&gt;% # dplyr::slice_sample(prop = 0.6) %&gt;% sf::st_intersection( aoi_sf %&gt;% # sf::st_centroid() %&gt;% sf::st_buffer(100, endCapStyle = &quot;SQUARE&quot;) %&gt;% sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf)) ) %&gt;% sf::st_transform(4326) , fill = NA, color = &quot;gray77&quot;, lwd = 0.1 , inherit.aes = F ) + ggplot2::labs(title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;)) + ggplot2::theme( plot.title = ggplot2::element_text(size = 12, hjust = 0, margin = ggplot2::margin(0,3,3,0)) ) 6.2.3.5 Tree Attributes Spatial this is a large area so we’re going to sample from the tree list crowns_temp &lt;- cloud2trees_ans$crowns_sf %&gt;% dplyr::slice_sample(prop = 0.6) plt_df_temp &lt;- dplyr::tibble( fill_var = c(&quot;tree_height_m&quot;, &quot;dbh_cm&quot;, &quot;tree_cbh_m&quot;, &quot;max_crown_diam_height_m&quot;, &quot;landfire_crown_biomass_kg&quot;) , palette = c(&quot;Blues&quot;, &quot;Oranges&quot;, &quot;Greens&quot;, &quot;Purples&quot;, &quot;Reds&quot;) , title = c(&quot;Height (m)&quot;, &quot;DBH (cm)&quot;, &quot;CBH (m)&quot;, &quot;HMD (m)&quot;, &quot;Crown\\nbiomass (kg)&quot;) ) plts_temp &lt;- 1:nrow(plt_df_temp) %&gt;% purrr::map( \\(x) plt_crown_attr_fn( crowns = crowns_temp , aoi = aoi_sf , lwd = 0.6 , fill_var = plt_df_temp$fill_var[x] , palette = plt_df_temp$palette[x] , title = plt_df_temp$title[x] ) ) # combine with patchwork patchwork::wrap_plots(plts_temp, ncol = 2) + patchwork::plot_annotation( title = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;) # , subtitle = &quot;huh&quot; # , caption = &quot;hey&quot; , theme = ggplot2::theme( plot.title = element_text(hjust = 0.5, margin = ggplot2::margin(0,0,3,0)) ) ) 6.2.3.6 Tree Attributes Summary Stats stats_sum_fn( crowns = cloud2trees_ans$crowns_sf %&gt;% ## !!!!!!!!!!!!!!!!!!!!!!!! cruz_tree_kg_per_m3 empty here dplyr::mutate(cruz_tree_kg_per_m3 = as.numeric(NA)) , aoi = aoi_sf , unit = paste0(aoi_sf$study_site_lab, &quot; - UAS Lidar&quot;) ) Table 6.4: Summary statistics for selected metrics Unit Name Metric Mean Median Std Dev Range Cedar Bridge (NJ) - UAS Lidar(70,353 trees) Height (m) 12.3 12.8 3.7 2.0—33.5 DBH (cm) 22.6 23.1 7.9 3.6—80.5 Crown Base Ht. (m) 4.9 4.9 1.4 1.5—19.5 HMD (m) 6.7 7.0 1.9 0.1—19.6 Cruz CBDkg m-3 NA NA NA NA—NA LANDFIRE CBDkg m-3 0.199 0.190 0.074 0.009—1.466 "],["point-cloud-processing-results.html", "Section 7 Point Cloud Processing Results 7.1 Processing Time 7.2 Silvicultural Metrics", " Section 7 Point Cloud Processing Results 7.1 Processing Time let’s look into the processing time comparison across data sets the cloud2trees::cloud2trees() program automatically tracks processing time for all sections and stores the tracking data in the “point_cloud_processing_delivery” directory in a file called “processed_tracking_data.csv” dir_temp &lt;- &quot;../data&quot; # what processing data? df_temp &lt;- list.files( dir_temp , pattern = &quot;processed_tracking_data.csv&quot; , recursive = T ) %&gt;% dplyr::tibble() %&gt;% setNames(&quot;fpath&quot;) %&gt;% dplyr::mutate( data_desc = stringr::word(fpath, 2, sep = &quot;/&quot;) %&gt;% stringr::str_remove_all(&quot;_processing&quot;) %&gt;% stringr::str_replace_all(&quot;_&quot;,&quot; &quot;) %&gt;% stringr::str_squish() %&gt;% toupper() , data_type = data_desc %&gt;% stringr::str_remove_all(&quot;[0-9]&quot;) %&gt;% stringr::str_squish() , study_site = stringr::word(fpath, sep = &quot;/&quot;) , fpath = file.path(dir_temp, fpath) , fdir = dirname(fpath) ) # read in processing data df_temp &lt;- 1:nrow(df_temp) %&gt;% purrr::map(\\(x) readr::read_csv( df_temp$fpath[x] , show_col_types = F , progress = F ) %&gt;% dplyr::mutate( study_site = df_temp$study_site[x] , data_desc = df_temp$data_desc[x] ) ) %&gt;% dplyr::bind_rows() %&gt;% dplyr::inner_join(df_temp, by = dplyr::join_by(study_site,data_desc)) # add in study bounds study_sites_processing_sf &lt;- study_sites_sf %&gt;% dplyr::select(study_site, study_site_lab) %&gt;% dplyr::inner_join( df_temp , by = &quot;study_site&quot; , relationship = &quot;one-to-many&quot; ) let’s relativize and proportionalize the tracking data # aggregate the total processing time study_sites_processing_sf &lt;- study_sites_processing_sf %&gt;% dplyr::mutate( timer_total_time_mins = timer_cloud2raster_mins + timer_raster2trees_mins + timer_trees_dbh_mins + timer_trees_cbh_mins + timer_trees_type_mins + timer_trees_hmd_mins + timer_trees_biomass_mins + timer_write_data_mins , timer_tree_extraction_mins = timer_cloud2raster_mins + timer_raster2trees_mins , las_area_ha = (las_area_m2/10000) , points_m2 = number_of_points/las_area_m2 # relative , dplyr::across( .cols = tidyselect::starts_with(&quot;timer_&quot;) &amp; tidyselect::ends_with(&quot;_mins&quot;) , .fns = ~ (.x*60)/las_area_ha # sec/ha # , .fns = ~ .x/las_area_ha # min/ha , .names = &quot;{.col}_secperha&quot; # , .names = &quot;{.col}_minperha&quot; ) # proportion , dplyr::across( .cols = c(timer_tree_extraction_mins, timer_trees_dbh_mins, timer_trees_cbh_mins, timer_trees_type_mins, timer_trees_hmd_mins, timer_trees_biomass_mins, timer_write_data_mins) , .fns = ~ .x/timer_total_time_mins , .names = &quot;{.col}_pct&quot; ) ) study_sites_processing_sf %&gt;% dplyr::glimpse() ## Rows: 8 ## Columns: 80 ## $ study_site &lt;chr&gt; &quot;FortStewart&quot;, &quot;FortStewart&quot;, &quot;N… ## $ study_site_lab &lt;chr&gt; &quot;Fort Stewart (GA)&quot;, &quot;Fort Stewa… ## $ number_of_points &lt;dbl&gt; 43073560, 340216525, 80299066, 7… ## $ las_area_m2 &lt;dbl&gt; 8999820.0, 6859980.4, 2064120.9,… ## $ timer_cloud2raster_mins &lt;dbl&gt; 8.722992, 128.585765, 22.147697,… ## $ timer_raster2trees_mins &lt;dbl&gt; 10.01676441, 5.58708338, 1.80076… ## $ timer_trees_competition_mins &lt;dbl&gt; 1.446803e-05, 1.419783e-05, 1.50… ## $ timer_treels_stem_dbh_mins &lt;dbl&gt; 6.755193e-08, 6.755193e-08, 6.75… ## $ timer_trees_dbh_mins &lt;dbl&gt; 8.720106, 11.735575, 5.896145, 7… ## $ timer_trees_cbh_mins &lt;dbl&gt; 129.23120, 109.18386, 115.54459,… ## $ timer_trees_type_mins &lt;dbl&gt; 0.31335723, 0.18822260, 0.101875… ## $ timer_trees_hmd_mins &lt;dbl&gt; 12.984603, 12.046923, 4.840216, … ## $ timer_trees_biomass_mins &lt;dbl&gt; 7.52738049, 3.10699495, 1.064633… ## $ timer_write_data_mins &lt;dbl&gt; 3.05878218, 1.16428173, 0.790324… ## $ timer_total_time_mins &lt;dbl&gt; 180.57519, 271.59871, 152.18625,… ## $ sttng_input_las_dir &lt;chr&gt; &quot;../data/fortstewart/als_2018_la… ## $ sttng_accuracy_level &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2 ## $ sttng_max_ctg_pts &lt;dbl&gt; 7e+07, 7e+07, 7e+07, 7e+07, 7e+0… ## $ sttng_max_area_m2 &lt;dbl&gt; 9e+07, 9e+07, 9e+07, 9e+07, 9e+0… ## $ sttng_dtm_res_m &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ sttng_chm_res_m &lt;dbl&gt; 0.30, 0.25, 0.25, 0.25, 0.25, 0.… ## $ sttng_min_height &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2 ## $ sttng_max_height &lt;dbl&gt; 70, 70, 70, 70, 70, 70, 70, 70 ## $ sttng_ws &lt;chr&gt; &quot;function (x) { y &lt;- dplyr::c… ## $ sttng_estimate_tree_dbh &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_max_dbh &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2 ## $ sttng_dbh_model &lt;chr&gt; &quot;lin&quot;, &quot;lin&quot;, &quot;lin&quot;, &quot;lin&quot;, &quot;lin… ## $ sttng_estimate_dbh_from_cloud &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALS… ## $ sttng_estimate_tree_competition &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALS… ## $ sttng_competition_buffer_m &lt;dbl&gt; 5, 5, 5, 5, 5, 5, 5, 5 ## $ sttng_competition_max_search_dist_m &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10 ## $ sttng_estimate_tree_type &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_type_max_search_dist_m &lt;dbl&gt; 1000, 1000, 1000, 1000, 1000, 10… ## $ sttng_estimate_tree_hmd &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_hmd_tree_sample_n &lt;dbl&gt; 20000, 20000, 20000, 20000, 2000… ## $ sttng_hmd_tree_sample_prop &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.… ## $ sttng_hmd_estimate_missing_hmd &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_estimate_biomass_method &lt;chr&gt; &quot;landfire,cruz&quot;, &quot;landfire,cruz&quot;… ## $ sttng_biomass_max_crown_kg_per_m3 &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2 ## $ sttng_estimate_tree_cbh &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_cbh_tree_sample_n &lt;dbl&gt; 20000, 20000, 20000, 20000, 2000… ## $ sttng_cbh_tree_sample_prop &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.… ## $ sttng_cbh_which_cbh &lt;chr&gt; &quot;lowest&quot;, &quot;lowest&quot;, &quot;lowest&quot;, &quot;l… ## $ sttng_cbh_estimate_missing_cbh &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TR… ## $ sttng_cbh_min_vhp_n &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3 ## $ sttng_cbh_voxel_grain_size_m &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ sttng_cbh_dist_btwn_bins_m &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ sttng_cbh_min_fuel_layer_ht_m &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ sttng_cbh_lad_pct_gap &lt;dbl&gt; 25, 25, 25, 25, 25, 25, 25, 25 ## $ sttng_cbh_lad_pct_base &lt;dbl&gt; 25, 25, 25, 25, 25, 25, 25, 25 ## $ sttng_cbh_num_jump_steps &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ sttng_cbh_min_lad_pct &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10 ## $ sttng_cbh_frst_layer_min_ht_m &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1 ## $ data_desc &lt;chr&gt; &quot;ALS 2018&quot;, &quot;ALS 2025&quot;, &quot;ALS 201… ## $ fpath &lt;chr&gt; &quot;../data/FortStewart/als_2018_pr… ## $ data_type &lt;chr&gt; &quot;ALS&quot;, &quot;ALS&quot;, &quot;ALS&quot;, &quot;UAS LIDAR&quot;… ## $ fdir &lt;chr&gt; &quot;../data/FortStewart/als_2018_pr… ## $ geometry &lt;POLYGON [m]&gt; POLYGON ((1336943 1097560, ..., … ## $ timer_tree_extraction_mins &lt;dbl&gt; 18.73976, 134.17285, 23.94847, 6… ## $ las_area_ha &lt;dbl&gt; 899.98200, 685.99804, 206.41209,… ## $ points_m2 &lt;dbl&gt; 4.786047, 49.594387, 38.902307, … ## $ timer_cloud2raster_mins_secperha &lt;dbl&gt; 0.5815444, 11.2466005, 6.4379067… ## $ timer_raster2trees_mins_secperha &lt;dbl&gt; 0.6677977, 0.4886676, 0.5234489,… ## $ timer_trees_competition_mins_secperha &lt;dbl&gt; 9.645549e-07, 1.241796e-06, 4.38… ## $ timer_treels_stem_dbh_mins_secperha &lt;dbl&gt; 4.503552e-09, 5.908349e-09, 1.96… ## $ timer_trees_dbh_mins_secperha &lt;dbl&gt; 0.5813521, 1.0264381, 1.7138954,… ## $ timer_trees_cbh_mins_secperha &lt;dbl&gt; 8.615586, 9.549636, 33.586577, 4… ## $ timer_trees_type_mins_secperha &lt;dbl&gt; 0.02089090, 0.01646267, 0.029613… ## $ timer_trees_hmd_mins_secperha &lt;dbl&gt; 0.8656575, 1.0536697, 1.4069571,… ## $ timer_trees_biomass_mins_secperha &lt;dbl&gt; 0.50183540, 0.27174961, 0.309468… ## $ timer_write_data_mins_secperha &lt;dbl&gt; 0.20392289, 0.10183251, 0.229731… ## $ timer_total_time_mins_secperha &lt;dbl&gt; 12.03859, 23.75506, 44.23760, 19… ## $ timer_tree_extraction_mins_secperha &lt;dbl&gt; 1.249342, 11.735268, 6.961356, 1… ## $ timer_tree_extraction_mins_pct &lt;dbl&gt; 0.1037781, 0.4940114, 0.1573629,… ## $ timer_trees_dbh_mins_pct &lt;dbl&gt; 0.048290724, 0.043209244… ## $ timer_trees_cbh_mins_pct &lt;dbl&gt; 0.7156642, 0.4020044, 0.7592315,… ## $ timer_trees_type_mins_pct &lt;dbl&gt; 0.0017353283, 0.0006930173, 0.00… ## $ timer_trees_hmd_mins_pct &lt;dbl&gt; 0.07190691, 0.04435560, 0.031804… ## $ timer_trees_biomass_mins_pct &lt;dbl&gt; 0.0416855752, 0.0114396529, 0.00… ## $ timer_write_data_mins_pct &lt;dbl&gt; 0.0169391058, 0.0042867720, 0.00… that’s a lot of tracking data, let’s look at the main timing parameters # format data for plotting/tabling table_temp &lt;- study_sites_processing_sf %&gt;% sf::st_drop_geometry() %&gt;% dplyr::select( study_site, study_site_lab, data_desc, data_type, number_of_points, las_area_ha, points_m2 , c(timer_tree_extraction_mins, timer_trees_dbh_mins, timer_trees_cbh_mins, timer_trees_type_mins, timer_trees_hmd_mins, timer_trees_biomass_mins, timer_write_data_mins , timer_total_time_mins , c(tidyselect::ends_with(&quot;_pct&quot;) &amp; tidyselect::starts_with(&quot;timer_&quot;)) , c(tidyselect::ends_with(&quot;_secperha&quot;) &amp; tidyselect::starts_with(&quot;timer_&quot;)) ) ) %&gt;% tidyr::pivot_longer( cols = -c(study_site, study_site_lab, data_desc, data_type, number_of_points, las_area_ha, points_m2) ) %&gt;% dplyr::mutate( units = stringr::word(name, -1, sep = &quot;_&quot;) , section = name %&gt;% stringr::str_remove_all(&quot;timer_&quot;) %&gt;% stringr::str_remove_all(&quot;_mins&quot;) %&gt;% stringr::str_remove_all(&quot;_pct&quot;) %&gt;% stringr::str_remove_all(&quot;_secperha&quot;) ) %&gt;% dplyr::select(-name) %&gt;% # dplyr::count(units) tidyr::pivot_wider(names_from = units, values_from = value) %&gt;% dplyr::mutate( mins_lab = scales::comma(mins,accuracy = 0.1) , perha_lab = scales::comma(secperha,accuracy = 0.01) , pct_lab = scales::percent(pct,accuracy = 0.1) # site lab , big_lab = stringr::str_c( data_desc , paste0(&quot;area: &quot;, scales::comma(las_area_ha, accuracy = 1, suffix = &quot; ha&quot;)) , paste0(&quot;points: &quot;, scales::comma(number_of_points, accuracy = 0.1, scale = 1/1000000, suffix = &quot;M&quot;)) , paste0(&quot;points m&lt;sup&gt;-2&lt;/sup&gt;: &quot;, scales::comma(points_m2, accuracy = 0.1)) , sep = &quot;&lt;br&gt;&quot; ) , big_lab_ggplot = stringr::str_c( data_desc , paste0(&quot;area: &quot;, scales::comma(las_area_ha, accuracy = 1, suffix = &quot; ha&quot;)) , paste0(&quot;points: &quot;, scales::comma(number_of_points, accuracy = 0.1, scale = 1/1000000, suffix = &quot;M&quot;)) , paste0(&quot;points/m2: &quot;, scales::comma(points_m2, accuracy = 0.1)) , sep = &quot;\\n&quot; ) ) %&gt;% # dplyr::count(section) dplyr::filter(!is.na(mins)) %&gt;% # section lab after filter so factor doesn&#39;t have rand levels dplyr::mutate( section = section %&gt;% stringr::str_replace_all(&quot;_&quot;, &quot; &quot;) %&gt;% stringr::str_remove_all(&quot;time&quot;) %&gt;% stringr::str_replace_all(&quot;dbh&quot;, &quot;DBH&quot;) %&gt;% stringr::str_replace_all(&quot;cbh&quot;, &quot;CBH&quot;) %&gt;% stringr::str_replace_all(&quot;hmd&quot;, &quot;HMD&quot;) %&gt;% stringr::str_squish() %&gt;% forcats::fct_inorder() ) # table it table_temp %&gt;% dplyr::select(study_site_lab,big_lab,section,mins_lab, perha_lab, pct_lab) %&gt;% kableExtra::kbl( caption = &quot;Point cloud processing section run time&quot; , col.names = c( &quot;Site&quot;, &quot;Data&quot; , &quot;Processing section&quot; , &quot;time (minutes)&quot; , &quot;seconds per ha&quot; , &quot;% of total time&quot; ) , escape = F ) %&gt;% kableExtra::kable_styling() %&gt;% kableExtra::collapse_rows(columns = 1:2, valign = &quot;top&quot;) Table 7.1: Point cloud processing section run time Site Data Processing section time (minutes) seconds per ha % of total time Fort Stewart (GA) ALS 2018area: 900 hapoints: 43.1Mpoints m-2: 4.8 tree extraction 18.7 1.25 10.4% trees DBH 8.7 0.58 4.8% trees CBH 129.2 8.62 71.6% trees type 0.3 0.02 0.2% trees HMD 13.0 0.87 7.2% trees biomass 7.5 0.50 4.2% write data 3.1 0.20 1.7% total 180.6 12.04 NA ALS 2025area: 686 hapoints: 340.2Mpoints m-2: 49.6 tree extraction 134.2 11.74 49.4% trees DBH 11.7 1.03 4.3% trees CBH 109.2 9.55 40.2% trees type 0.2 0.02 0.1% trees HMD 12.0 1.05 4.4% trees biomass 3.1 0.27 1.1% write data 1.2 0.10 0.4% total 271.6 23.76 NA Cedar Bridge (NJ) ALS 2012area: 206 hapoints: 80.3Mpoints m-2: 38.9 tree extraction 23.9 6.96 15.7% trees DBH 5.9 1.71 3.9% trees CBH 115.5 33.59 75.9% trees type 0.1 0.03 0.1% trees HMD 4.8 1.41 3.2% trees biomass 1.1 0.31 0.7% write data 0.8 0.23 0.5% total 152.2 44.24 NA UAS LIDAR 2024area: 292 hapoints: 758.3Mpoints m-2: 259.7 tree extraction 664.8 136.59 70.5% trees DBH 7.8 1.60 0.8% trees CBH 237.3 48.76 25.2% trees type 0.5 0.10 0.1% trees HMD 30.3 6.24 3.2% trees biomass 0.5 0.09 0.0% write data 1.2 0.24 0.1% total 942.3 193.62 NA Salt Cabin (CO) ALS 2021area: 534 hapoints: 35.2Mpoints m-2: 6.6 tree extraction 22.6 2.54 22.1% trees DBH 11.5 1.29 11.2% trees CBH 59.1 6.65 57.8% trees type 1.5 0.17 1.5% trees HMD 3.1 0.35 3.0% trees biomass 2.0 0.22 1.9% write data 2.5 0.28 2.4% total 102.3 11.50 NA UAS SFM 2024area: 28 hapoints: 94.5Mpoints m-2: 339.1 tree extraction 65.4 140.77 79.3% trees DBH 3.7 8.04 4.5% trees CBH 11.8 25.33 14.3% trees type 0.0 0.02 0.0% trees HMD 1.4 3.12 1.8% trees biomass 0.1 0.15 0.1% write data 0.1 0.13 0.1% total 82.5 177.56 NA Sycan Marsh (OR) ALS 2021area: 200 hapoints: 68.0Mpoints m-2: 34.0 tree extraction 17.8 5.35 22.1% trees DBH 4.4 1.31 5.4% trees CBH 55.0 16.50 68.1% trees type 0.0 0.01 0.1% trees HMD 2.3 0.68 2.8% trees biomass 0.9 0.27 1.1% write data 0.3 0.10 0.4% total 80.8 24.23 NA UAS LIDAR 2023area: 53 hapoints: 200.5Mpoints m-2: 378.3 tree extraction 55.9 63.31 63.7% trees DBH 3.1 3.52 3.5% trees CBH 25.1 28.37 28.6% trees type 0.0 0.01 0.0% trees HMD 3.4 3.85 3.9% trees biomass 0.1 0.13 0.1% write data 0.1 0.13 0.1% total 87.8 99.33 NA that’s a lot of numbers to digest, let’s plot the data 7.1.1 Point Cloud Processing Time versus Point Density # per ha time based on point density ggplot2::ggplot( data = table_temp %&gt;% dplyr::filter(section == &quot;total&quot;) , mapping = ggplot2::aes(y = secperha, x = points_m2, color = data_type) ) + ggplot2::geom_point(size = 4, alpha = 0.9) + ggplot2::scale_color_viridis_d(option = &quot;magma&quot;, begin = 0.1, end = 0.5) + ggplot2::labs( x = latex2exp::TeX(&quot;points $m^{-2}$&quot;) , y = latex2exp::TeX(&quot;total seconds $ha^{-1}$&quot;) , color = &quot;&quot; , subtitle = &quot;Point Cloud Processing Time versus Point Density&quot; ) + ggplot2::theme_light() + ggplot2::theme(legend.position = &quot;top&quot;) 7.1.2 Point Cloud Processing Time by Section (%) table_temp %&gt;% dplyr::filter(section != &quot;total&quot;) %&gt;% dplyr::mutate(section = forcats::fct_rev(section)) %&gt;% ggplot2::ggplot( mapping = ggplot2::aes(y = big_lab_ggplot, x = pct, fill = section, group = section) ) + ggplot2::geom_col( width = 0.7, alpha=0.8 ) + ggplot2::geom_text( mapping = ggplot2::aes( label = scales::percent(ifelse(pct&gt;=0.06,pct,NA), accuracy = 1) , fontface = &quot;bold&quot; ) , position = ggplot2::position_stack(vjust = 0.5) , color = &quot;black&quot;, size = 4 ) + ggplot2::facet_wrap(facets = dplyr::vars(study_site_lab), scales = &quot;free_y&quot;) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, begin = 0.1, end = 0.9) + ggplot2::scale_x_continuous(labels = scales::percent_format()) + labs( fill = &quot;&quot;, y = &quot;&quot; , x = &quot;% Point Cloud Total Processing Time&quot; , subtitle = &quot;Point Cloud Processing Time by Section&quot; ) + theme_light() + theme( legend.position = &quot;top&quot; , legend.direction = &quot;horizontal&quot; , legend.title = element_text(size=7) , axis.title.x = element_text(size=10, face = &quot;bold&quot;) , axis.title.y = element_text(size = 8) , axis.text.x = element_blank() , axis.text.y = element_text(color = &quot;black&quot;,size=10, face = &quot;bold&quot;) , axis.ticks.x = element_blank() ) + guides( fill = guide_legend(nrow = 3, byrow = T, reverse = T, override.aes = list(alpha = 0.9)) ) 7.1.3 Point Cloud Processing Time by Section (total) table_temp %&gt;% dplyr::filter(section != &quot;total&quot;) %&gt;% dplyr::mutate(section = forcats::fct_rev(section)) %&gt;% ggplot2::ggplot( mapping = ggplot2::aes(y = big_lab_ggplot, x = secperha, fill = section, group = section) ) + geom_text( data = table_temp %&gt;% dplyr::filter(section == &quot;total&quot;) , mapping = ggplot2::aes( y = big_lab_ggplot , x = secperha , label = scales::comma(secperha,accuracy=0.1,suffix = &quot;\\ntotal&quot;) , fontface = &quot;bold&quot; ) , color = &quot;black&quot;, size = 2.3 , hjust = -0.1 ) + ggplot2::geom_col( width = 0.7, alpha=0.8 ) + ggplot2::geom_text( mapping = ggplot2::aes( label = scales::comma(ifelse(secperha&gt;=7.5,secperha,NA), accuracy = 0.1) , fontface = &quot;bold&quot; ) , position = ggplot2::position_stack(vjust = 0.5) , color = &quot;black&quot;, size = 3 ) + ggplot2::facet_wrap(facets = dplyr::vars(study_site_lab), scales = &quot;free_y&quot;) + ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, begin = 0.1, end = 0.9) + ggplot2::scale_x_continuous(labels = scales::comma_format(), expand = ggplot2::expansion(mult = c(0,0.1))) + labs( fill = &quot;&quot;, y = &quot;&quot; , x = latex2exp::TeX(&quot;seconds $ha^{-1}$&quot;) , subtitle = &quot;Point Cloud Processing Time by Section&quot; ) + theme_light() + theme( legend.position = &quot;top&quot; , legend.direction = &quot;horizontal&quot; , legend.title = element_text(size=7) , axis.title.x = element_text(size=10, face = &quot;bold&quot;) , axis.title.y = element_text(size = 8) , axis.text.x = element_blank() , axis.text.y = element_text(color = &quot;black&quot;,size=10, face = &quot;bold&quot;) , axis.ticks.x = element_blank() ) + guides( fill = guide_legend(nrow = 3, byrow = T, reverse = T, override.aes = list(alpha = 0.9)) ) 7.2 Silvicultural Metrics let’s make a function to read the tree list data, keep only trees in an AOI, and aggregate to get common silvicultural metrics # function to clip a tree list to an aoi clip_tree_list_aoi &lt;- function( # point_cloud_processing_delivery trees , aoi , bbox_aoi = F , buffer = 0 # in the coordinates of trees , reproject_epsg = NULL ) { if(!inherits(trees,&quot;sf&quot;)){stop(&quot;trees must be sf class object&quot;)} if(!inherits(aoi,&quot;sf&quot;)){stop(&quot;aoi must be sf class object&quot;)} if(is.na(sf::st_crs(trees))){stop(&quot;trees does not have a CRS&quot;)} if(is.na(sf::st_crs(aoi))){stop(&quot;aoi does not have a CRS&quot;)} # check epsg buff if(is.character(reproject_epsg)){ reproject_epsg &lt;- readr::parse_number(reproject_epsg) } if(is.character(buffer)){ buffer &lt;- readr::parse_number(buffer) } # check for polygons if( sf::st_is(trees, c(&quot;POLYGON&quot;,&quot;MULTIPOLYGON&quot;)) %&gt;% any() ){ # check for xy if( (names(trees) %&gt;% stringr::str_detect(&quot;tree_x&quot;) %&gt;% any()) &amp;&amp; (names(trees) %&gt;% stringr::str_detect(&quot;tree_y&quot;) %&gt;% any()) ){ tree_pts &lt;- trees %&gt;% sf::st_drop_geometry() %&gt;% sf::st_as_sf(coords = c(&quot;tree_x&quot;, &quot;tree_y&quot;), crs = sf::st_crs(trees)) }else{ tree_pts &lt;- trees %&gt;% sf::st_centroid() } }else if( sf::st_is(trees, c(&quot;POINT&quot;)) %&gt;% all() ){ tree_pts &lt;- trees }else{ stop(&quot;trees must contain POINT or POLYGON type geometries only&quot;) } # bounds if( !all( sf::st_is(aoi, c(&quot;POLYGON&quot;,&quot;MULTIPOLYGON&quot;)) ) ){ stop(&quot;aoi must contain POLYGON type geometry only&quot;) } if(nrow(aoi)!=1){ stop(&quot;aoi must only have a single record geometry&quot;) } # reproj if(!is.null(reproject_epsg) &amp;&amp; is.numeric(reproject_epsg)){ tree_pts &lt;- tree_pts %&gt;% sf::st_transform(crs = reproject_epsg) } # bbox if(bbox_aoi){ aoi &lt;- sf::st_bbox(aoi) %&gt;% sf::st_as_sfc() %&gt;% sf::st_transform(sf::st_crs(tree_pts)) }else{ aoi &lt;- aoi %&gt;% sf::st_transform(sf::st_crs(tree_pts)) } # buff if(buffer&gt;0){ aoi &lt;- sf::st_buffer(aoi, buffer) } # intersect based on points but filter original tree list trees &lt;- trees %&gt;% dplyr::slice( sf::st_intersects(tree_pts, aoi, sparse = F) %&gt;% which() ) if(nrow(trees)==0){ warning(&quot;no trees found within aoi bounds&quot;) return(NULL) }else{ return(trees) } } # clip_tree_list_aoi( # trees = sf::st_read(&quot;c:/data/usfs/dod_cloud2trees_demo/data/SycanMarsh/als_2021_processing/point_cloud_processing_delivery/final_detected_crowns.gpkg&quot;) # , aoi = sf::st_read(&quot;c:/data/usfs/dod_cloud2trees_demo/data/SycanMarsh/Sycan_2A.shp&quot;) # ) %&gt;% # dplyr::glimpse() let’s clip the tree list to the study bounds for each result for using with LANL TREES and Quic-Fire "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
