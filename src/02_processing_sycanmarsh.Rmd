# Sycan Marsh (OR)

process the point cloud data for the Sycan Marsh (OR) study site

let's check out the data we have and the area

```{r}
# just get the data we care about
aoi_study_site <- "SycanMarsh"
aoi_sf <- study_sites_sf %>% dplyr::filter(study_site == aoi_study_site)
aoi_las_ctg <- study_sites_las_ctg %>% 
  purrr::keep_at(
    names(study_sites_las_ctg)[
      stringr::str_detect(names(study_sites_las_ctg), aoi_study_site)
    ]
  )
# option to put satellite imagery as base layer of mapview maps
mapview::mapviewOptions(
  homebutton = FALSE
  , basemaps = c("Esri.WorldImagery","OpenStreetMap")
)
# map it
# add the study bounds
mapview::mapview(
  aoi_las_ctg[[1]]$geometry
  , color = "black"
  , lwd = 2
  , alpha.regions = 0
  , layer.name = names(aoi_las_ctg[1])
  , legend = F
  , popup = F
) +
mapview::mapview(
  aoi_las_ctg[[2]]$geometry
  , color = "gray"
  , lwd = 2
  , alpha.regions = 0
  , layer.name = names(aoi_las_ctg[2])
  , legend = F
  , popup = F
) +
mapview::mapview(
  aoi_sf
  , zcol = "study_site_lab"
  , color = "navy"
  , lwd = 2
  , alpha.regions = 0
  , legend = T
  , popup = F
)
```

point cloud data summary

```{r}
aoi_las_ctg
```

## ALS Processing

### ITD tuning

put las files in a list
```{r}
# list of all las files
las_flist_temp <- aoi_las_ctg[["SycanMarsh_als"]] %>% 
  purrr::pluck("data") %>% 
  dplyr::pull(filename)
```

run tuning

```{r}
# if there is an error with tuning...is it because there are no trees for a given ws_fn?
    # Caused by error in `dplyr::group_by()`:
    # ! Must group by variables found in `.data`.
    # Column `ws_fn` is not found.
if(!file.exists("../data/itd_tuning_SycanMarsh_als.jpg")){
  # tuning
  itd_tuning_ans <- cloud2trees::itd_tuning(
      input_las_dir = las_flist_temp
      , n_samples = 2
      , ws_fn_list = my_ws_functions
    )
  ggplot2::ggsave(
    "../data/itd_tuning_SycanMarsh_als.jpg"
    , plot = itd_tuning_ans$plot_samples
    , dpi = "print"
    , height = 6, width = 10
  )
}
```

```{r, echo=FALSE, out.width="100%", out.height="100%", fig.align='center', fig.show='hold', results='asis'}
# this is so we get the actual result that we used for tuning
# knitr::include_graphics("../data/itd_tuning_SycanMarsh_als.jpg")
knitr::include_graphics("https://i.ibb.co/VpqjxXSf/itd-tuning-Sycan-Marsh-als.jpg")
```

pick the best function for use in ITD

```{r}
# pick the best function for use in ITD
best_ws_fn_temp <- my_ws_functions$exp_fn
```

### `cloud2trees` point cloud processing

```{r sycanmarsh-als}
dir_temp <- file.path(aoi_sf$fdir, "als_processing")
if(!dir.exists(dir_temp)){
  dir.create(dir_temp)
# c2t
  cloud2trees_ans <- cloud2trees::cloud2trees(
    input_las_dir = las_flist_temp
    , output_dir = dir_temp
    , ws = best_ws_fn_temp
    , dtm_res_m = 1
    , chm_res_m = 0.25
    , estimate_tree_dbh = T
    , estimate_tree_type = T
    # hmd
    , estimate_tree_hmd = T
    , hmd_tree_sample_prop = 0.5
    , hmd_estimate_missing_hmd = T
    # biomass
    , estimate_biomass_method = c("landfire","cruz")
    # cbh
    , estimate_tree_cbh = T
    , cbh_tree_sample_prop = 0.5
    , cbh_estimate_missing_cbh = T
  )
}else{
  cloud2trees_ans <- list(
    "dtm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "dtm_1m.tif") )
    , "chm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "chm_0.25m.tif") )
    , "crowns_sf" = list.files(
        file.path(dir_temp, "point_cloud_processing_delivery")
        , pattern = "final_detected_crowns.*\\.gpkg$"
        , full.names = T
      ) %>% 
      normalizePath() %>% 
      purrr::map(\(x)
        sf::st_read(
          dsn = x
          , quiet = T
        )
      ) %>% 
      dplyr::bind_rows()
  )
}
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(itd_tuning_ans)
gc()
```

### `cloud2trees` Results

#### DTM

```{r}
plt_rast_poly_fn <- function(
  rast
  , poly
  , crop = T
  , mask = F
  , buff = 22
  , col = "red"
  , lwd = 1
  , title = ""
  , leg_pos = "top"
) {
  if(crop){
    rast <- rast %>% 
      terra::crop(
        poly %>% 
          sf::st_buffer(buff) %>% 
          sf::st_transform(terra::crs(rast)) %>% 
          terra::vect()
      )
  }
  if(mask){
    rast <- rast %>% 
      terra::mask(
        poly %>% 
          sf::st_buffer(buff) %>% 
          sf::st_transform(terra::crs(rast)) %>% 
          terra::vect()
      )
  }
  
  # Convert SpatRaster to a data frame for ggplot
  rast_df <- terra::as.data.frame(rast, xy=TRUE) %>% rename(f=3)

  # Create the base raster plot
  p <- ggplot2::ggplot() +
    ggplot2::geom_raster(
      data = rast_df, aes(x = x, y = y, fill = f)
    ) +
    ggplot2::scale_fill_viridis_c() + # Use a colorblind-friendly palette
    # ggplot2::coord_sf(crs = terra::crs(rast)) +  # Match the CRS
    ggplot2::labs(fill = "") +
    ggplot2::theme_void() +
    ggplot2::theme(
      legend.position = leg_pos
      , legend.text = ggplot2::element_text(angle = 90, vjust = 0.5, size = 7)
      , plot.subtitle = ggplot2::element_text(hjust = 0.5)
    )

  # Add the polygon overlay
  p <- p +
    ggplot2::geom_sf(
      data = poly %>% sf::st_transform(terra::crs(rast))
      , fill = NA, color = col, lwd = lwd
    ) +
    ggplot2::labs(subtitle = title)

  return(p)
}

plt_rast_poly_fn(rast = cloud2trees_ans$dtm_rast, poly = aoi_sf, title = "DTM (m)") +
  harrypotter::scale_fill_hp(
    option = "mischief", alpha = 0.9, labels = scales::comma_format(accuracy=1), breaks = scales::breaks_extended(n=6)
  )

cloud2trees_ans$dtm_rast %>% 
  terra::crop(
    aoi_sf %>% 
      sf::st_buffer(22) %>% 
      sf::st_transform(terra::crs(cloud2trees_ans$dtm_rast)) %>% 
      terra::vect()
  ) %>% 
  terra::plot(
    col = harrypotter::hp(n=100, option = "mischief", alpha = 0.9)
    , axes=F
    , main = "DTM (m)"
  )
terra::plot(
  aoi_sf %>% 
      sf::st_transform(terra::crs(cloud2trees_ans$dtm_rast)) %>% 
      terra::vect()
  , add = T, border = "navy", col = NA, lwd = 1.5
)
```

#### CHM

plot the CHM and we'll also add the extracted trees in gray

```{r}
cloud2trees_ans$chm_rast %>% 
  terra::crop(
    aoi_sf %>% 
      sf::st_buffer(22) %>% 
      sf::st_transform(terra::crs(cloud2trees_ans$chm_rast)) %>% 
      terra::vect()
  ) %>% 
  terra::plot(
    col = viridis::plasma(n=100, alpha = 0.9)
    , axes=F
    , main = "CHM (m)"
  )
terra::plot(
  aoi_sf %>% 
      sf::st_transform(terra::crs(cloud2trees_ans$chm_rast)) %>% 
      terra::vect()
  , add = T, border = "navy", col = NA, lwd = 1.5
)
terra::plot(
  cloud2trees_ans$crowns_sf %>% 
    sf::st_intersection(
      aoi_sf %>% 
        sf::st_transform(sf::st_crs(cloud2trees_ans$crowns_sf))
    ) %>% 
    sf::st_transform(terra::crs(cloud2trees_ans$chm_rast)) %>% 
    terra::vect()
  # cloud2trees_ans$crowns_sf %>% 
  #   sf::st_transform(sf::st_crs(aoi_sf)) %>% 
  #   sf::st_intersection(aoi_sf) %>% 
  #   sf::st_transform(terra::crs(cloud2trees_ans$chm_rast)) %>% 
  #   terra::vect()
  , add = T, border = "black", col = NA, lwd = 0.9
)
```


let's check the tree extraction results on satellite imagery with a collection date that may not coincide with the point cloud collection date

## UAS lidar Processing

### ITD tuning

put las files in a list
```{r}
# list of all las files
las_flist_temp <- aoi_las_ctg[["SycanMarsh_uas_lidar"]] %>% 
  purrr::pluck("data") %>% 
  dplyr::pull(filename)
```

run tuning

```{r}
# if there is an error with tuning...is it because there are no trees for a given ws_fn?
    # Caused by error in `dplyr::group_by()`:
    # ! Must group by variables found in `.data`.
    # Column `ws_fn` is not found.
if(!file.exists("../data/itd_tuning_SycanMarsh_uas_lidar.jpg")){
  # tuning
  itd_tuning_ans <- cloud2trees::itd_tuning(
      input_las_dir = las_flist_temp
      , n_samples = 2
      , ws_fn_list = my_ws_functions
    )
  ggplot2::ggsave(
    "../data/itd_tuning_SycanMarsh_uas_lidar.jpg"
    , plot = itd_tuning_ans$plot_samples
    , dpi = "print"
    , height = 6, width = 10
  )
}
```

```{r, echo=FALSE, out.width="100%", out.height="100%", fig.align='center', fig.show='hold', results='asis'}
# this is so we get the actual result that we used for tuning
# knitr::include_graphics("../data/itd_tuning_SycanMarsh_uas_lidar.jpg")
knitr::include_graphics("https://i.ibb.co/mdBgNsv/itd-tuning-Sycan-Marsh-uas-lidar.jpg")
```

pick the best function for use in ITD

```{r}
# pick the best function for use in ITD
best_ws_fn_temp <- my_ws_functions$lin_fn
```

### `cloud2trees` point cloud processing

```{r sycanmarsh-uas}
dir_temp <- file.path(aoi_sf$fdir, "uas_lidar_processing")
if(!dir.exists(dir_temp)){
  dir.create(dir_temp)
# c2t
  cloud2trees_ans <- cloud2trees::cloud2trees(
    input_las_dir = las_flist_temp
    , output_dir = dir_temp
    , ws = best_ws_fn_temp
    , dtm_res_m = 1
    , chm_res_m = 0.25
    , estimate_tree_dbh = T
    , estimate_tree_type = T
    # hmd
    , estimate_tree_hmd = T
    , hmd_tree_sample_prop = 0.5
    , hmd_estimate_missing_hmd = T
    # biomass
    , estimate_biomass_method = c("landfire","cruz")
    # cbh
    , estimate_tree_cbh = T
    , cbh_tree_sample_prop = 0.5
    , cbh_estimate_missing_cbh = T
  )
}else{
  cloud2raster_ans <- list(
    "dtm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "dtm_1m.tif") )
    , "chm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "chm_0.25m.tif") )
    , "crowns_sf" = list.files(
        file.path(dir_temp, "point_cloud_processing_delivery")
        , pattern = "final_detected_crowns.*\\.gpkg$"
        , full.names = T
      ) %>% 
      normalizePath() %>% 
      purrr::map(\(x)
        sf::st_read(
          dsn = x
          , quiet = T
        )
      ) %>% 
      dplyr::bind_rows()
  )
}
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(itd_tuning_ans)
gc()
```
