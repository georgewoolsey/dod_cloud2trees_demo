# Fort Stewart (GA)

process the point cloud data for the Fort Stewart (GA) study site

let's check out the data we have and the area

```{r}
# just get the data we care about
aoi_study_site <- "FortStewart"
aoi_sf <- study_sites_sf %>% dplyr::filter(study_site == aoi_study_site)
aoi_las_ctg <- study_sites_las_ctg %>% 
  purrr::keep_at(
    names(study_sites_las_ctg)[
      stringr::str_detect(names(study_sites_las_ctg), aoi_study_site)
    ]
  )
# option to put satellite imagery as base layer of mapview maps
mapview::mapviewOptions(
  homebutton = FALSE
  , basemaps = c("Esri.WorldImagery","OpenStreetMap")
)
# map it
# add the study bounds
mapview::mapview(
  aoi_las_ctg[[1]]$geometry
  , color = "black"
  , lwd = 2
  , alpha.regions = 0
  , layer.name = names(aoi_las_ctg[1])
  , legend = F
  , popup = F
) +
mapview::mapview(
  aoi_sf
  , zcol = "study_site_lab"
  , color = "navy"
  , lwd = 2
  , alpha.regions = 0
  , legend = T
  , popup = F
)
```

point cloud data summary

```{r}
aoi_las_ctg
```

## ALS Processing

### ITD tuning

put las files in a list
```{r}
# list of all las files
las_flist_temp <- aoi_las_ctg[["FortStewart_als"]] %>% 
  purrr::pluck("data") %>% 
  dplyr::pull(filename)
```

run tuning

```{r}
# if there is an error with tuning...is it because there are no trees for a given ws_fn?
    # Caused by error in `dplyr::group_by()`:
    # ! Must group by variables found in `.data`.
    # Column `ws_fn` is not found.
if(!file.exists("../data/itd_tuning_FortStewart_als.jpg")){
  # tuning
  itd_tuning_ans <- cloud2trees::itd_tuning(
      input_las_dir = las_flist_temp
      , n_samples = 3
      , ws_fn_list = my_ws_functions
      , chm_res_m = 0.3
    )
  ggplot2::ggsave(
    "../data/itd_tuning_FortStewart_als.jpg"
    , plot = itd_tuning_ans$plot_samples
    , dpi = "print"
    , height = 7, width = 10
  )
}
```

```{r, echo=FALSE, out.width="100%", out.height="100%", fig.align='center', fig.show='hold', results='asis'}
# this is so we get the actual result that we used for tuning
# knitr::include_graphics("../data/itd_tuning_FortStewart_als.jpg")
knitr::include_graphics("https://i.ibb.co/RG1LdCq9/itd-tuning-Fort-Stewart-als.jpg")
```

pick the best function for use in ITD

```{r}
# pick the best function for use in ITD
best_ws_fn_temp <- my_ws_functions$exp_fn
```

### `cloud2trees` point cloud processing

```{r fortstewart-als}
dir_temp <- file.path(aoi_sf$fdir, "als_processing")
if(!dir.exists(dir_temp)){
  dir.create(dir_temp)
# c2t
  cloud2trees_ans <- cloud2trees::cloud2trees(
    input_las_dir = las_flist_temp
    , output_dir = dir_temp
    , ws = best_ws_fn_temp
    , dtm_res_m = 1
    , chm_res_m = 0.3
    , estimate_tree_dbh = T
    , estimate_tree_type = T
    # hmd
    , estimate_tree_hmd = T
    , hmd_tree_sample_prop = 0.5
    , hmd_estimate_missing_hmd = T
    # biomass
    , estimate_biomass_method = c("landfire","cruz")
    # cbh
    , estimate_tree_cbh = T
    , cbh_tree_sample_prop = 0.5
    , cbh_estimate_missing_cbh = T
  )
}else{
  cloud2raster_ans <- list(
    "dtm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "dtm_1m.tif") )
    , "chm_rast" = terra::rast( file.path(dir_temp, "point_cloud_processing_delivery", "chm_0.3m.tif") )
    , "crowns_sf" = list.files(
        file.path(dir_temp, "point_cloud_processing_delivery")
        , pattern = "final_detected_crowns.*\\.gpkg$"
        , full.names = T
      ) %>% 
      normalizePath() %>% 
      purrr::map(\(x)
        sf::st_read(
          dsn = x
          , quiet = T
        )
      ) %>% 
      dplyr::bind_rows()
  )
}
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(itd_tuning_ans)
gc()
```

